<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>postMessage æµ‹è¯•</title>
    <style>
        body { font-family: monospace; padding: 20px; }
        .log { background: #f5f5f5; padding: 15px; margin: 10px 0; border-radius: 5px; }
        button { padding: 10px 20px; margin: 5px; font-size: 16px; cursor: pointer; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
    </style>
</head>
<body>
    <h1>ğŸ§ª postMessage é€šä¿¡æµ‹è¯•</h1>
    
    <div>
        <button onclick="testSendMessage()">å‘é€ç”¨æˆ·ä¿¡æ¯åˆ° iframe</button>
        <button onclick="checkIframeInfo()">æ£€æŸ¥ iframe ç”¨æˆ·ä¿¡æ¯</button>
        <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
    </div>

    <h2>ğŸ“ æ—¥å¿—</h2>
    <div id="log" class="log"></div>

    <hr>
    <iframe 
        id="scratch-iframe"
        src="http://localhost:8601/" 
        style="width: 100%; height: 600px; border: 2px solid #ccc;"
    ></iframe>

    <script>
        const iframe = document.getElementById('scratch-iframe');
        const logEl = document.getElementById('log');

        function addLog(message, type = 'info') {
            const time = new Date().toLocaleTimeString();
            const line = document.createElement('div');
            line.className = type;
            line.textContent = `[${time}] ${message}`;
            logEl.appendChild(line);
            logEl.scrollTop = logEl.scrollHeight;
        }

        function clearLog() {
            logEl.innerHTML = '';
        }

        // ç­‰å¾… iframe åŠ è½½
        iframe.onload = () => {
            addLog('âœ… iframe å·²åŠ è½½å®Œæˆ', 'success');
            
            // ç­‰å¾… 2 ç§’åè‡ªåŠ¨å‘é€æ¶ˆæ¯
            setTimeout(() => {
                addLog('â³ 2 ç§’åè‡ªåŠ¨å‘é€æµ‹è¯•æ¶ˆæ¯...', 'info');
                setTimeout(testSendMessage, 2000);
            }, 0);
        };

        function testSendMessage() {
            addLog('=== å¼€å§‹æµ‹è¯• postMessage ===', 'info');
            
            const userInfo = {
                isLoggedIn: true,
                username: 'æŸ³è€å¸ˆ',
                avatarUrl: null
            };

            addLog('å‡†å¤‡å‘é€çš„ç”¨æˆ·ä¿¡æ¯: ' + JSON.stringify(userInfo), 'info');

            if (!iframe.contentWindow) {
                addLog('âŒ iframe.contentWindow ä¸å­˜åœ¨ï¼', 'error');
                return;
            }

            addLog('âœ… iframe.contentWindow å­˜åœ¨', 'success');

            try {
                iframe.contentWindow.postMessage({
                    type: 'USER_INFO_UPDATE',
                    data: userInfo
                }, '*');
                addLog('âœ… postMessage å·²å‘é€ï¼', 'success');
                addLog('ç­‰å¾… iframe æ¥æ”¶...', 'info');
                
                // 3 ç§’åæ£€æŸ¥ iframe æ˜¯å¦æ”¶åˆ°
                setTimeout(checkIframeInfo, 3000);
            } catch (error) {
                addLog('âŒ å‘é€å¤±è´¥: ' + error.message, 'error');
            }
        }

        function checkIframeInfo() {
            addLog('=== æ£€æŸ¥ iframe ç”¨æˆ·ä¿¡æ¯ ===', 'info');
            
            // æ³¨æ„ï¼šç”±äºè·¨åŸŸï¼Œæˆ‘ä»¬æ— æ³•ç›´æ¥è®¿é—® iframe çš„ window å¯¹è±¡
            // ä½†æˆ‘ä»¬å¯ä»¥å‘é€ä¸€ä¸ªæŸ¥è¯¢æ¶ˆæ¯
            iframe.contentWindow.postMessage({
                type: 'QUERY_USER_INFO'
            }, '*');
            
            addLog('âœ… å·²å‘é€æŸ¥è¯¢è¯·æ±‚ï¼Œç­‰å¾… iframe å“åº”...', 'info');
        }

        // ç›‘å¬æ¥è‡ª iframe çš„æ¶ˆæ¯
        window.addEventListener('message', (event) => {
            if (event.origin !== 'http://localhost:8601') {
                return;
            }
            
            addLog('ğŸ“¨ æ”¶åˆ° iframe çš„æ¶ˆæ¯: ' + JSON.stringify(event.data), 'success');
        });

        addLog('ğŸš€ æµ‹è¯•å·¥å…·å·²å¯åŠ¨ï¼Œç­‰å¾… iframe åŠ è½½...', 'info');
    </script>
</body>
</html>

