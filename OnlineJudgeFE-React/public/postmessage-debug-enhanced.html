<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>PostMessage å¢å¼ºè°ƒè¯•å·¥å…·</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            padding: 0;
            margin: 0;
            background: #1a1a1a;
            color: #0f0;
            display: flex;
            height: 100vh;
        }
        .left-panel {
            width: 40%;
            background: #000;
            border-right: 2px solid #0a0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .right-panel {
            width: 60%;
            display: flex;
            flex-direction: column;
        }
        .controls {
            background: #2a2a2a;
            padding: 15px;
            border-bottom: 2px solid #0a0;
        }
        h2 {
            margin: 0 0 10px 0;
            color: #0ff;
            font-size: 18px;
        }
        button {
            background: #0a0;
            color: #000;
            border: none;
            padding: 10px 15px;
            margin: 3px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 13px;
            font-weight: bold;
        }
        button:hover {
            background: #0f0;
        }
        button:active {
            background: #080;
        }
        #logs {
            flex: 1;
            background: #000;
            padding: 15px;
            overflow-y: auto;
            font-size: 12px;
            line-height: 1.6;
        }
        .log-entry {
            margin: 3px 0;
            padding: 5px 8px;
            border-left: 3px solid #0a0;
            padding-left: 10px;
            word-wrap: break-word;
        }
        .log-parent {
            border-left-color: #ff0;
            color: #ff0;
        }
        .log-iframe {
            border-left-color: #0ff;
            color: #0ff;
        }
        .log-send {
            border-left-color: #f0f;
            color: #f0f;
        }
        .log-receive {
            border-left-color: #0f0;
            color: #0f0;
        }
        .log-error {
            border-left-color: #f00;
            color: #f00;
        }
        .log-success {
            border-left-color: #0f0;
            color: #0f0;
            font-weight: bold;
        }
        iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        .status-bar {
            background: #2a2a2a;
            padding: 10px 15px;
            border-top: 2px solid #0a0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        .status-dot.online {
            background: #0f0;
        }
        .status-dot.offline {
            background: #f00;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .stats {
            font-size: 11px;
            color: #888;
        }
    </style>
</head>
<body>
    <div class="left-panel">
        <div class="controls">
            <h2>ğŸ”¬ PostMessage è°ƒè¯•æ§åˆ¶å°</h2>
            <div style="margin: 10px 0;">
                <button onclick="login()">ğŸ” æ¨¡æ‹Ÿç™»å½•</button>
                <button onclick="logout()">ğŸšª æ¨¡æ‹Ÿé€€å‡º</button>
                <button onclick="sendTestMessage()">ğŸ“¤ å‘é€æµ‹è¯•æ¶ˆæ¯</button>
            </div>
            <div>
                <button onclick="checkStatus()">ğŸ” æ£€æŸ¥çŠ¶æ€</button>
                <button onclick="refreshIframe()">ğŸ”„ åˆ·æ–°ç¼–è¾‘å™¨</button>
                <button onclick="clearLogs()">ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—</button>
            </div>
        </div>

        <div id="logs"></div>

        <div class="status-bar">
            <div class="status-item">
                <span class="status-dot" id="status"></span>
                <span>iframe è¿æ¥</span>
            </div>
            <div class="stats">
                <span>å‘é€: <strong id="sendCount">0</strong></span> | 
                <span>æ¥æ”¶: <strong id="receiveCount">0</strong></span>
            </div>
        </div>
    </div>

    <div class="right-panel">
        <div class="controls">
            <h2>ğŸ“º Scratch ç¼–è¾‘å™¨ (http://localhost:8601/)</h2>
            <div style="font-size: 11px; color: #888; margin-top: 5px;">
                ğŸ’¡ æç¤ºï¼šç¼–è¾‘å™¨å†…éƒ¨çš„æ—¥å¿—ä¼šè‡ªåŠ¨æ˜¾ç¤ºåœ¨å·¦ä¾§é¢æ¿
            </div>
        </div>
        <iframe id="scratchIframe" src="http://localhost:8601/"></iframe>
    </div>

    <script>
        const logsDiv = document.getElementById('logs');
        const statusDot = document.getElementById('status');
        const sendCountEl = document.getElementById('sendCount');
        const receiveCountEl = document.getElementById('receiveCount');
        
        let iframe = null;
        let sendCount = 0;
        let receiveCount = 0;

        function log(message, type = 'info', source = 'parent') {
            const timestamp = new Date().toLocaleTimeString() + '.' + String(new Date().getMilliseconds()).padStart(3, '0');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            
            if (source === 'iframe') {
                entry.classList.add('log-iframe');
                message = 'ğŸ“± [iframe] ' + message;
            } else if (source === 'parent') {
                entry.classList.add('log-parent');
                message = 'ğŸ–¥ï¸ [parent] ' + message;
            }
            
            entry.textContent = `[${timestamp}] ${message}`;
            logsDiv.appendChild(entry);
            logsDiv.scrollTop = logsDiv.scrollHeight;
            
            // åŒæ—¶è¾“å‡ºåˆ°æ§åˆ¶å°
            console.log(`[${source}][${type}] ${message}`);
        }

        function clearLogs() {
            logsDiv.innerHTML = '';
            sendCount = 0;
            receiveCount = 0;
            updateStats();
            log('æ—¥å¿—å·²æ¸…ç©º', 'info');
        }

        function updateStats() {
            sendCountEl.textContent = sendCount;
            receiveCountEl.textContent = receiveCount;
        }

        function checkStatus() {
            iframe = document.getElementById('scratchIframe');
            
            log('å¼€å§‹æ£€æŸ¥ iframe çŠ¶æ€...', 'info');
            
            if (iframe) {
                log('âœ… iframe å…ƒç´ å­˜åœ¨', 'success');
                log(`iframe.src = ${iframe.src}`, 'info');
                
                if (iframe.contentWindow) {
                    log('âœ… iframe.contentWindow å¯è®¿é—®', 'success');
                    statusDot.className = 'status-dot online';
                    
                    // å°è¯•æ³¨å…¥æ—¥å¿—æ‹¦æˆªå™¨
                    try {
                        injectLogInterceptor();
                    } catch (e) {
                        log(`âš ï¸ æ— æ³•æ³¨å…¥æ—¥å¿—æ‹¦æˆªå™¨ï¼ˆè·¨åŸŸé™åˆ¶ï¼‰: ${e.message}`, 'error');
                        log('ğŸ’¡ è¿™æ˜¯æ­£å¸¸çš„ï¼Œæˆ‘ä»¬ä¼šä½¿ç”¨ postMessage æ¥æ¥æ”¶æ—¥å¿—', 'info');
                    }
                } else {
                    log('âŒ iframe.contentWindow ä¸å¯è®¿é—®', 'error');
                    statusDot.className = 'status-dot offline';
                }
            } else {
                log('âŒ iframe å…ƒç´ ä¸å­˜åœ¨', 'error');
                statusDot.className = 'status-dot offline';
            }
        }

        function injectLogInterceptor() {
            // æ³¨æ„ï¼šç”±äºè·¨åŸŸé™åˆ¶ï¼Œè¿™ä¸ªæ–¹æ³•é€šå¸¸ä¼šå¤±è´¥
            // ä½†æˆ‘ä»¬å¯ä»¥å°è¯•
            const iframeWindow = iframe.contentWindow;
            
            if (iframeWindow && iframeWindow.postMessage) {
                log('å°è¯•ä¸ iframe å»ºç«‹æ—¥å¿—é€šé“...', 'info');
            }
        }

        function login() {
            iframe = document.getElementById('scratchIframe');
            
            if (!iframe || !iframe.contentWindow) {
                log('âŒ iframe æœªå‡†å¤‡å¥½', 'error');
                return;
            }

            const userInfo = {
                isLoggedIn: true,
                username: 'æŸ³è€å¸ˆ',
                avatarUrl: null
            };

            log('å‡†å¤‡å‘é€ç™»å½•æ¶ˆæ¯', 'send');
            log(`ç”¨æˆ·ä¿¡æ¯: ${JSON.stringify(userInfo)}`, 'send');

            try {
                iframe.contentWindow.postMessage({
                    type: 'USER_INFO_UPDATE',
                    data: userInfo
                }, '*');

                sendCount++;
                updateStats();
                log('âœ… USER_INFO_UPDATE æ¶ˆæ¯å·²å‘é€', 'success');
                log('â³ ç­‰å¾… iframe å“åº”...', 'info');
                
                // 5ç§’åæ£€æŸ¥æ˜¯å¦æˆåŠŸ
                setTimeout(() => {
                    log('ğŸ’¡ è¯·æŸ¥çœ‹å³ä¾§ç¼–è¾‘å™¨ï¼Œå³ä¸Šè§’åº”è¯¥æ˜¾ç¤º"æŸ³è€å¸ˆ"', 'info');
                }, 2000);
            } catch (e) {
                log(`âŒ å‘é€å¤±è´¥: ${e.message}`, 'error');
            }
        }

        function logout() {
            iframe = document.getElementById('scratchIframe');
            
            if (!iframe || !iframe.contentWindow) {
                log('âŒ iframe æœªå‡†å¤‡å¥½', 'error');
                return;
            }

            const userInfo = {
                isLoggedIn: false,
                username: null,
                avatarUrl: null
            };

            log('å‡†å¤‡å‘é€é€€å‡ºç™»å½•æ¶ˆæ¯', 'send');
            log(`ç”¨æˆ·ä¿¡æ¯: ${JSON.stringify(userInfo)}`, 'send');

            try {
                iframe.contentWindow.postMessage({
                    type: 'USER_INFO_UPDATE',
                    data: userInfo
                }, '*');

                sendCount++;
                updateStats();
                log('âœ… USER_INFO_UPDATE æ¶ˆæ¯å·²å‘é€ï¼ˆé€€å‡ºç™»å½•ï¼‰', 'success');
            } catch (e) {
                log(`âŒ å‘é€å¤±è´¥: ${e.message}`, 'error');
            }
        }

        function sendTestMessage() {
            iframe = document.getElementById('scratchIframe');
            
            if (!iframe || !iframe.contentWindow) {
                log('âŒ iframe æœªå‡†å¤‡å¥½', 'error');
                return;
            }

            const testData = {
                type: 'TEST_MESSAGE',
                data: {
                    message: 'Hello from parent window!',
                    timestamp: new Date().toISOString(),
                    random: Math.random()
                }
            };

            log('å‘é€æµ‹è¯•æ¶ˆæ¯', 'send');
            log(`æ•°æ®: ${JSON.stringify(testData)}`, 'send');

            try {
                iframe.contentWindow.postMessage(testData, '*');
                sendCount++;
                updateStats();
                log('âœ… æµ‹è¯•æ¶ˆæ¯å·²å‘é€', 'success');
            } catch (e) {
                log(`âŒ å‘é€å¤±è´¥: ${e.message}`, 'error');
            }
        }

        function refreshIframe() {
            iframe = document.getElementById('scratchIframe');
            if (iframe) {
                log('ğŸ”„ æ­£åœ¨åˆ·æ–° iframe...', 'info');
                iframe.src = iframe.src;
            }
        }

        // ç›‘å¬æ‰€æœ‰ postMessage äº‹ä»¶
        window.addEventListener('message', (event) => {
            receiveCount++;
            updateStats();
            
            // ç‰¹æ®Šå¤„ç†ï¼šUSER_INFO_UPDATE_ACK
            if (event.data && event.data.type === 'USER_INFO_UPDATE_ACK') {
                log(`ğŸ‰ æ”¶åˆ° iframe ç¡®è®¤æ¶ˆæ¯ï¼`, 'success', 'iframe');
                log(`iframe å·²æˆåŠŸæ¥æ”¶å¹¶å¤„ç†ç™»å½•ä¿¡æ¯`, 'success', 'iframe');
                log(`ç”¨æˆ·ä¿¡æ¯: ${JSON.stringify(event.data.data.userInfo)}`, 'success', 'iframe');
                log(`æ—¶é—´æˆ³: ${event.data.data.timestamp}`, 'success', 'iframe');
                return;
            }
            
            log(`æ”¶åˆ°æ¶ˆæ¯ [æ¥æº: ${event.origin}]`, 'receive');
            
            if (event.data) {
                if (typeof event.data === 'object') {
                    log(`ç±»å‹: ${event.data.type || 'æœªçŸ¥'}`, 'receive');
                    
                    // ç¾åŒ– JSON è¾“å‡º
                    const dataStr = JSON.stringify(event.data, null, 2);
                    const lines = dataStr.split('\n');
                    if (lines.length > 10) {
                        log(`æ•°æ®: ${lines.slice(0, 10).join('\n')}...`, 'receive');
                    } else {
                        log(`æ•°æ®: ${dataStr}`, 'receive');
                    }
                    
                    // ç‰¹æ®Šå¤„ç†ï¼šwebpack æ¶ˆæ¯æ¥è‡ª iframe
                    if (event.data.type && (
                        event.data.type.includes('webpack') || 
                        event.data.type === 'webpackOk'
                    )) {
                        log(`(è¿™æ˜¯ webpack HMR æ¶ˆæ¯ï¼Œæ¥è‡ª iframe)`, 'info', 'iframe');
                    }
                } else {
                    log(`æ•°æ®: ${String(event.data).substring(0, 200)}`, 'receive');
                }
            }
        }, false);

        // é¡µé¢åŠ è½½å®Œæˆ
        window.addEventListener('load', () => {
            log('ğŸš€ è°ƒè¯•å·¥å…·å·²å¯åŠ¨', 'success');
            log('ğŸ’¡ æç¤ºï¼šç”±äºè·¨åŸŸå®‰å…¨é™åˆ¶ï¼Œæˆ‘ä»¬æ— æ³•ç›´æ¥è®¿é—® iframe çš„ console.log', 'info');
            log('ğŸ’¡ ä½†æˆ‘ä»¬å¯ä»¥æ¥æ”¶åˆ° iframe å‘é€çš„ postMessage äº‹ä»¶', 'info');
            
            setTimeout(() => {
                checkStatus();
                log('â³ ç­‰å¾… Scratch ç¼–è¾‘å™¨åŠ è½½å®Œæˆï¼ˆçº¦5ç§’ï¼‰...', 'info');
            }, 2000);

            // å®šæœŸæ£€æŸ¥ iframe çŠ¶æ€
            setInterval(() => {
                const iframe = document.getElementById('scratchIframe');
                if (iframe && iframe.contentWindow) {
                    statusDot.className = 'status-dot online';
                } else {
                    statusDot.className = 'status-dot offline';
                }
            }, 1000);
        });

        // ç›‘å¬ iframe åŠ è½½å®Œæˆ
        document.getElementById('scratchIframe').addEventListener('load', () => {
            log('âœ… iframe å†…å®¹å·²åŠ è½½å®Œæˆ', 'success');
            checkStatus();
            
            setTimeout(() => {
                log('ğŸ’¡ ç°åœ¨å¯ä»¥ç‚¹å‡»"æ¨¡æ‹Ÿç™»å½•"æµ‹è¯• postMessage é€šä¿¡', 'info');
            }, 1000);
        });

        // ç›‘å¬ iframe é”™è¯¯
        document.getElementById('scratchIframe').addEventListener('error', (e) => {
            log(`âŒ iframe åŠ è½½å¤±è´¥: ${e.message}`, 'error');
        });
    </script>
</body>
</html>

