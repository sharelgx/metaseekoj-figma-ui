<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>å®Œå…¨è‡ªåŠ¨åŒ–æµ‹è¯•</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #000;
            color: #0f0;
            font-size: 14px;
        }
        .test { padding: 10px; margin: 5px 0; border-left: 4px solid #666; }
        .pass { border-left-color: #0f0; color: #0f0; }
        .fail { border-left-color: #f00; color: #f00; }
        .running { border-left-color: #00f; color: #00f; }
        iframe { width: 1px; height: 1px; position: absolute; left: -9999px; }
    </style>
</head>
<body>
    <h1>ðŸ¤– å®Œå…¨è‡ªåŠ¨åŒ–æµ‹è¯•ï¼ˆæ— éœ€äººå·¥å¹²é¢„ï¼‰</h1>
    <div id="output"></div>
    <iframe id="iframe" src="http://localhost:8601/"></iframe>
    
    <script>
        const output = document.getElementById('output');
        let testsPassed = 0;
        let testsFailed = 0;

        function log(msg, status = 'info') {
            const div = document.createElement('div');
            div.className = `test ${status}`;
            div.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            output.appendChild(div);
            console.log(msg);
        }

        async function sleep(ms) {
            return new Promise(r => setTimeout(r, ms));
        }

        async function runTests() {
            log('ðŸš€ å¼€å§‹è‡ªåŠ¨åŒ–æµ‹è¯•...', 'running');
            await sleep(1000);

            // æµ‹è¯• 1: æ£€æŸ¥æœåŠ¡
            log('ðŸ“‹ æµ‹è¯• 1: æ£€æŸ¥åŽç«¯æœåŠ¡', 'running');
            try {
                const res = await fetch('http://localhost:8086/api/website/');
                if (res.ok) {
                    log('âœ… æµ‹è¯• 1 é€šè¿‡: åŽç«¯æœåŠ¡æ­£å¸¸', 'pass');
                    testsPassed++;
                } else {
                    throw new Error('çŠ¶æ€ç : ' + res.status);
                }
            } catch (e) {
                log('âŒ æµ‹è¯• 1 å¤±è´¥: ' + e.message, 'fail');
                testsFailed++;
            }

            // æµ‹è¯• 2: ç™»å½•
            log('ðŸ“‹ æµ‹è¯• 2: ç™»å½•ç³»ç»Ÿ', 'running');
            try {
                const res = await fetch('http://localhost:8086/api/login/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ username: 'root', password: 'lgx780504' })
                });
                const data = await res.json();
                if (data.error === null) {
                    log('âœ… æµ‹è¯• 2 é€šè¿‡: ç™»å½•æˆåŠŸ', 'pass');
                    testsPassed++;
                } else {
                    throw new Error(data.error);
                }
            } catch (e) {
                log('âŒ æµ‹è¯• 2 å¤±è´¥: ' + e.message, 'fail');
                testsFailed++;
            }

            // æµ‹è¯• 3: ç­‰å¾… VM åˆå§‹åŒ–
            log('ðŸ“‹ æµ‹è¯• 3: ç­‰å¾… Scratch VM åˆå§‹åŒ–', 'running');
            try {
                await new Promise((resolve, reject) => {
                    const timeout = setTimeout(() => reject(new Error('è¶…æ—¶')), 15000);
                    const handler = (e) => {
                        if (e.data && e.data.type === 'SCRATCH_VM_READY') {
                            clearTimeout(timeout);
                            window.removeEventListener('message', handler);
                            resolve();
                        }
                    };
                    window.addEventListener('message', handler);
                });
                log('âœ… æµ‹è¯• 3 é€šè¿‡: VM åˆå§‹åŒ–æˆåŠŸ', 'pass');
                testsPassed++;
            } catch (e) {
                log('âŒ æµ‹è¯• 3 å¤±è´¥: ' + e.message, 'fail');
                testsFailed++;
                showSummary();
                return;
            }

            // æµ‹è¯• 4: å¯¼å‡ºé¡¹ç›®æ•°æ®
            log('ðŸ“‹ æµ‹è¯• 4: å¯¼å‡ºé¡¹ç›®æ•°æ®', 'running');
            try {
                const projectData = await new Promise((resolve, reject) => {
                    const timeout = setTimeout(() => reject(new Error('è¶…æ—¶')), 5000);
                    const handler = (e) => {
                        if (e.data && e.data.type === 'EXPORT_PROJECT_RESPONSE') {
                            clearTimeout(timeout);
                            window.removeEventListener('message', handler);
                            resolve(e.data.data);
                        }
                    };
                    window.addEventListener('message', handler);
                    
                    document.getElementById('iframe').contentWindow.postMessage({
                        type: 'EXPORT_PROJECT_REQUEST'
                    }, '*');
                });
                
                const size = JSON.stringify(projectData).length;
                log(`âœ… æµ‹è¯• 4 é€šè¿‡: å¯¼å‡ºæˆåŠŸ (${size} å­—èŠ‚)`, 'pass');
                testsPassed++;
                
                // æµ‹è¯• 5: ä¿å­˜åˆ°åŽç«¯
                log('ðŸ“‹ æµ‹è¯• 5: ä¿å­˜é¡¹ç›®åˆ°åŽç«¯', 'running');
                
                const csrfToken = document.cookie.split(';').find(c => c.trim().startsWith('csrftoken='))?.split('=')[1];
                
                const saveRes = await fetch('http://localhost:8086/api/scratch/projects/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken || ''
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        title: 'è‡ªåŠ¨åŒ–æµ‹è¯•é¡¹ç›® ' + new Date().toLocaleTimeString(),
                        description: 'ç”±è‡ªåŠ¨åŒ–æµ‹è¯•åˆ›å»º',
                        is_public: true,
                        data_json: projectData
                    })
                });
                
                const saveData = await saveRes.json();
                
                if (saveData.error === null && saveData.data && saveData.data.id) {
                    log(`âœ… æµ‹è¯• 5 é€šè¿‡: é¡¹ç›®ä¿å­˜æˆåŠŸ (ID: ${saveData.data.id})`, 'pass');
                    testsPassed++;
                    
                    window.testProjectId = saveData.data.id;
                    
                    // æµ‹è¯• 6: è¯»å–é¡¹ç›®
                    log('ðŸ“‹ æµ‹è¯• 6: è¯»å–å·²ä¿å­˜çš„é¡¹ç›®', 'running');
                    const getRes = await fetch(`http://localhost:8086/api/scratch/projects/${saveData.data.id}/`, {
                        credentials: 'include'
                    });
                    const getData = await getRes.json();
                    
                    if (getData.error === null && getData.data) {
                        log('âœ… æµ‹è¯• 6 é€šè¿‡: é¡¹ç›®è¯»å–æˆåŠŸ', 'pass');
                        testsPassed++;
                    } else {
                        throw new Error('è¯»å–å¤±è´¥');
                    }
                    
                    // æµ‹è¯• 7: åˆ é™¤é¡¹ç›®
                    log('ðŸ“‹ æµ‹è¯• 7: åˆ é™¤æµ‹è¯•é¡¹ç›®', 'running');
                    const delRes = await fetch(`http://localhost:8086/api/scratch/projects/${saveData.data.id}/`, {
                        method: 'DELETE',
                        headers: { 'X-CSRFToken': csrfToken || '' },
                        credentials: 'include'
                    });
                    
                    if (delRes.ok) {
                        log('âœ… æµ‹è¯• 7 é€šè¿‡: é¡¹ç›®åˆ é™¤æˆåŠŸ', 'pass');
                        testsPassed++;
                    } else {
                        throw new Error('åˆ é™¤å¤±è´¥');
                    }
                } else {
                    throw new Error(saveData.error || 'ä¿å­˜è¿”å›žæ•°æ®å¼‚å¸¸');
                }
            } catch (e) {
                if (e.message.includes('æµ‹è¯• 5')) {
                    log('âŒ æµ‹è¯• 5 å¤±è´¥: ' + e.message, 'fail');
                } else if (e.message.includes('æµ‹è¯• 6')) {
                    log('âŒ æµ‹è¯• 6 å¤±è´¥: ' + e.message, 'fail');
                } else if (e.message.includes('æµ‹è¯• 7')) {
                    log('âŒ æµ‹è¯• 7 å¤±è´¥: ' + e.message, 'fail');
                } else {
                    log('âŒ æµ‹è¯• 4 å¤±è´¥: ' + e.message, 'fail');
                }
                testsFailed++;
            }

            showSummary();
        }

        function showSummary() {
            log('', 'info');
            log('========================================', 'info');
            log(`æ€»è®¡: ${testsPassed + testsFailed} ä¸ªæµ‹è¯•`, 'info');
            log(`é€šè¿‡: ${testsPassed}`, testsPassed > 0 ? 'pass' : 'info');
            log(`å¤±è´¥: ${testsFailed}`, testsFailed > 0 ? 'fail' : 'info');
            log('========================================', 'info');
            
            if (testsFailed === 0) {
                log('', 'info');
                log('ðŸŽ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼ä¿å­˜åŠŸèƒ½å®Œå…¨æ­£å¸¸ï¼', 'pass');
                log('', 'info');
                log('âœ… ä½ çŽ°åœ¨å¯ä»¥åœ¨ç¼–è¾‘å™¨ä¸­æ­£å¸¸ä½¿ç”¨ä¿å­˜åŠŸèƒ½äº†', 'pass');
                log('âœ… è®¿é—® http://localhost:8081/classroom/scratch/editor', 'pass');
                log('âœ… åˆ›å»ºä½œå“åŽç‚¹å‡» "æ–‡ä»¶" â†’ "ç«‹å³ä¿å­˜"', 'pass');
            } else {
                log('', 'info');
                log('âŒ æœ‰æµ‹è¯•å¤±è´¥ï¼Œéœ€è¦æŽ’æŸ¥é—®é¢˜', 'fail');
            }
        }

        // è‡ªåŠ¨è¿è¡Œ
        window.addEventListener('load', () => {
            log('â³ ç­‰å¾… 5 ç§’è®© Scratch ç¼–è¾‘å™¨åŠ è½½...', 'info');
            setTimeout(() => {
                runTests();
            }, 5000);
        });
    </script>
</body>
</html>

