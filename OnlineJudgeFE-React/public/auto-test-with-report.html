<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>è‡ªåŠ¨åŒ–æµ‹è¯•ï¼ˆå¸¦ç»“æœæŠ¥å‘Šï¼‰</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #000;
            color: #0f0;
        }
        .test { padding: 10px; margin: 5px 0; border-left: 4px solid #666; }
        .pass { border-left-color: #0f0; color: #0f0; }
        .fail { border-left-color: #f00; color: #f00; }
        iframe { width: 1px; height: 1px; position: absolute; left: -9999px; }
        #summary { font-size: 18px; margin-top: 20px; padding: 20px; background: #1a1a1a; border: 2px solid #0a0; }
    </style>
</head>
<body>
    <h1>ğŸ¤– è‡ªåŠ¨åŒ–æµ‹è¯•ï¼ˆè‡ªåŠ¨æŠ¥å‘Šç»“æœï¼‰</h1>
    <div id="output"></div>
    <div id="summary"></div>
    <iframe id="iframe" src="http://localhost:8601/"></iframe>
    
    <script>
        const output = document.getElementById('output');
        const summary = document.getElementById('summary');
        let testsPassed = 0;
        let testsFailed = 0;
        let testResults = [];

        function log(msg, status = 'info') {
            const div = document.createElement('div');
            div.className = `test ${status}`;
            div.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            output.appendChild(div);
            console.log(msg);
            
            testResults.push({ time: new Date().toLocaleTimeString(), msg, status });
        }

        async function sleep(ms) {
            return new Promise(r => setTimeout(r, ms));
        }

        async function sendResultToBackend(result) {
            try {
                // å°†æµ‹è¯•ç»“æœå‘é€åˆ°åç«¯ï¼ˆå¦‚æœæœ‰ç«¯ç‚¹ï¼‰
                // è¿™é‡Œæš‚æ—¶åªåœ¨æ§åˆ¶å°è¾“å‡º
                console.log('========== æµ‹è¯•ç»“æœ JSON ==========');
                console.log(JSON.stringify(result, null, 2));
                console.log('===================================');
            } catch (e) {
                console.error('å‘é€ç»“æœå¤±è´¥:', e);
            }
        }

        async function runTests() {
            log('ğŸš€ å¼€å§‹è‡ªåŠ¨åŒ–æµ‹è¯•...', 'running');
            await sleep(1000);

            // æµ‹è¯• 1: åç«¯æœåŠ¡
            log('ğŸ“‹ æµ‹è¯• 1: æ£€æŸ¥åç«¯æœåŠ¡', 'running');
            try {
                const res = await fetch('http://localhost:8086/api/website/');
                if (res.ok) {
                    log('âœ… æµ‹è¯• 1 é€šè¿‡: åç«¯æœåŠ¡æ­£å¸¸', 'pass');
                    testsPassed++;
                } else throw new Error('çŠ¶æ€ç : ' + res.status);
            } catch (e) {
                log('âŒ æµ‹è¯• 1 å¤±è´¥: ' + e.message, 'fail');
                testsFailed++;
            }

            // æµ‹è¯• 2: ç™»å½•
            log('ğŸ“‹ æµ‹è¯• 2: ç™»å½•ç³»ç»Ÿ', 'running');
            try {
                const res = await fetch('http://localhost:8086/api/login/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ username: 'root', password: 'lgx780504' })
                });
                const data = await res.json();
                if (data.error === null) {
                    log('âœ… æµ‹è¯• 2 é€šè¿‡: ç™»å½•æˆåŠŸ', 'pass');
                    testsPassed++;
                } else throw new Error(data.error);
            } catch (e) {
                log('âŒ æµ‹è¯• 2 å¤±è´¥: ' + e.message, 'fail');
                testsFailed++;
            }

            // æµ‹è¯• 3: iframe åŠ è½½
            log('ğŸ“‹ æµ‹è¯• 3: æ£€æŸ¥ iframe çŠ¶æ€', 'running');
            const iframe = document.getElementById('iframe');
            if (iframe && iframe.contentWindow) {
                log('âœ… æµ‹è¯• 3 é€šè¿‡: iframe æ­£å¸¸åŠ è½½', 'pass');
                testsPassed++;
            } else {
                log('âŒ æµ‹è¯• 3 å¤±è´¥: iframe æœªåŠ è½½', 'fail');
                testsFailed++;
                showSummary();
                return;
            }

            // æµ‹è¯• 4: ç­‰å¾… VM åˆå§‹åŒ–
            log('ğŸ“‹ æµ‹è¯• 4: ç­‰å¾… VM åˆå§‹åŒ–ï¼ˆæœ€å¤š15ç§’ï¼‰', 'running');
            try {
                await new Promise((resolve, reject) => {
                    const timeout = setTimeout(() => {
                        log('âš ï¸ VM åˆå§‹åŒ–è¶…æ—¶ï¼Œæ£€æŸ¥æ˜¯å¦æ”¶åˆ°ä»»ä½•æ¶ˆæ¯...', 'fail');
                        reject(new Error('è¶…æ—¶'));
                    }, 15000);
                    
                    const handler = (e) => {
                        // è®°å½•æ‰€æœ‰æ”¶åˆ°çš„æ¶ˆæ¯
                        if (e.origin.includes('localhost')) {
                            console.log('æ”¶åˆ°æ¶ˆæ¯:', e.data);
                        }
                        
                        if (e.data && e.data.type === 'SCRATCH_VM_READY') {
                            clearTimeout(timeout);
                            window.removeEventListener('message', handler);
                            resolve();
                        }
                    };
                    window.addEventListener('message', handler);
                });
                log('âœ… æµ‹è¯• 4 é€šè¿‡: VM åˆå§‹åŒ–æˆåŠŸ', 'pass');
                testsPassed++;
            } catch (e) {
                log('âŒ æµ‹è¯• 4 å¤±è´¥: ' + e.message, 'fail');
                testsFailed++;
                showSummary();
                return;
            }

            // æµ‹è¯• 5: å¯¼å‡ºæ•°æ®
            log('ğŸ“‹ æµ‹è¯• 5: æµ‹è¯•å¯¼å‡ºåŠŸèƒ½', 'running');
            try {
                const data = await new Promise((resolve, reject) => {
                    const timeout = setTimeout(() => reject(new Error('è¶…æ—¶')), 5000);
                    const handler = (e) => {
                        if (e.data && e.data.type === 'EXPORT_PROJECT_RESPONSE') {
                            clearTimeout(timeout);
                            window.removeEventListener('message', handler);
                            resolve(e.data.data);
                        }
                    };
                    window.addEventListener('message', handler);
                    iframe.contentWindow.postMessage({ type: 'EXPORT_PROJECT_REQUEST' }, '*');
                });
                
                const size = JSON.stringify(data).length;
                log(`âœ… æµ‹è¯• 5 é€šè¿‡: å¯¼å‡ºæˆåŠŸ (${size} å­—èŠ‚, ${data.targets?.length || 0} ä¸ªå¯¹è±¡)`, 'pass');
                testsPassed++;
                
                // æµ‹è¯• 6: ä¿å­˜åˆ°åç«¯
                log('ğŸ“‹ æµ‹è¯• 6: ä¿å­˜é¡¹ç›®åˆ°åç«¯', 'running');
                const csrf = document.cookie.split(';').find(c => c.trim().startsWith('csrftoken='))?.split('=')[1];
                const saveRes = await fetch('http://localhost:8086/api/scratch/projects/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrf || '' },
                    credentials: 'include',
                    body: JSON.stringify({
                        title: 'è‡ªåŠ¨æµ‹è¯• ' + new Date().toLocaleTimeString(),
                        description: 'è‡ªåŠ¨åŒ–æµ‹è¯•åˆ›å»º',
                        is_public: true,
                        data_json: data
                    })
                });
                
                const saveData = await saveRes.json();
                if (saveData.error === null && saveData.data?.id) {
                    log(`âœ… æµ‹è¯• 6 é€šè¿‡: ä¿å­˜æˆåŠŸ (ID: ${saveData.data.id})`, 'pass');
                    testsPassed++;
                    
                    // è‡ªåŠ¨åˆ é™¤æµ‹è¯•é¡¹ç›®
                    await fetch(`http://localhost:8086/api/scratch/projects/${saveData.data.id}/`, {
                        method: 'DELETE',
                        headers: { 'X-CSRFToken': csrf || '' },
                        credentials: 'include'
                    });
                } else {
                    throw new Error(saveData.error || 'ID ä¸ºç©º');
                }
            } catch (e) {
                log('âŒ æµ‹è¯•å¤±è´¥: ' + e.message, 'fail');
                testsFailed++;
            }

            showSummary();
        }

        function showSummary() {
            const total = testsPassed + testsFailed;
            const passed = testsFailed === 0;
            
            summary.innerHTML = `
                <h2 style="color: ${passed ? '#0f0' : '#f00'};">
                    ${passed ? 'ğŸ‰ æµ‹è¯•é€šè¿‡ï¼' : 'âŒ æµ‹è¯•å¤±è´¥'}
                </h2>
                <div>æ€»è®¡: ${total} ä¸ªæµ‹è¯•</div>
                <div style="color: #0f0;">é€šè¿‡: ${testsPassed}</div>
                <div style="color: #f00;">å¤±è´¥: ${testsFailed}</div>
                ${passed ? '<div style="margin-top: 20px; color: #0ff;">âœ… ä¿å­˜åŠŸèƒ½å®Œå…¨æ­£å¸¸ï¼Œå¯ä»¥ä½¿ç”¨äº†ï¼</div>' : ''}
            `;
            
            const result = {
                timestamp: new Date().toISOString(),
                total, testsPassed, testsFailed, passed,
                details: testResults
            };
            
            sendResultToBackend(result);
            
            // åœ¨æ–‡æ¡£æ ‡é¢˜ä¸­æ˜¾ç¤ºç»“æœï¼ˆæ–¹ä¾¿æŸ¥çœ‹ï¼‰
            document.title = passed ? 'âœ… æµ‹è¯•é€šè¿‡' : `âŒ å¤±è´¥ ${testsFailed}/${total}`;
        }

        // è‡ªåŠ¨è¿è¡Œ
        window.addEventListener('load', () => {
            log('â³ ç­‰å¾… 6 ç§’è®© Scratch ç¼–è¾‘å™¨å®Œå…¨åŠ è½½...', 'info');
            setTimeout(runTests, 6000);
        });
    </script>
</body>
</html>

