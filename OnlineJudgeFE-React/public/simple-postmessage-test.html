<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>PostMessage åŸºç¡€æµ‹è¯•</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #000; color: #0f0; }
        .log { padding: 10px; margin: 5px 0; background: #0a0a0a; border-left: 4px solid #0a0; }
        button { background: #0a0; color: #000; border: none; padding: 15px 30px; margin: 10px 5px; cursor: pointer; border-radius: 4px; font-size: 16px; font-weight: bold; }
        button:hover { background: #0f0; }
        iframe { width: 100%; height: 400px; border: 2px solid #0a0; margin: 20px 0; }
    </style>
</head>
<body>
    <h1>ğŸ§ª PostMessage åŸºç¡€é€šä¿¡æµ‹è¯•</h1>
    
    <button onclick="sendTestMessage()">ğŸ“¤ å‘é€æµ‹è¯•æ¶ˆæ¯</button>
    <button onclick="location.reload()">ğŸ”„ åˆ·æ–°</button>
    
    <div id="logs"></div>
    
    <h2>Scratch ç¼–è¾‘å™¨ï¼ˆç‹¬ç«‹ï¼‰</h2>
    <iframe id="iframe" src="http://localhost:8601/"></iframe>

    <script>
        const logsDiv = document.getElementById('logs');
        let messageCount = 0;

        function log(msg) {
            const div = document.createElement('div');
            div.className = 'log';
            div.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            logsDiv.appendChild(div);
            console.log(msg);
        }

        function sendTestMessage() {
            const iframe = document.getElementById('iframe');
            
            if (!iframe || !iframe.contentWindow) {
                log('âŒ iframe æœªå‡†å¤‡å¥½');
                return;
            }
            
            log('ğŸ“¨ å‘é€ TEST_MESSAGE...');
            iframe.contentWindow.postMessage({
                type: 'TEST_MESSAGE',
                data: { hello: 'world', timestamp: new Date().toISOString() }
            }, '*');
            log('âœ… æ¶ˆæ¯å·²å‘é€');
        }

        // ç›‘å¬æ‰€æœ‰æ¶ˆæ¯
        window.addEventListener('message', (event) => {
            messageCount++;
            log(`ğŸ“¬ æ”¶åˆ°æ¶ˆæ¯ #${messageCount} [æ¥æº: ${event.origin}]`);
            log(`   ç±»å‹: ${event.data?.type || 'unknown'}`);
            log(`   æ•°æ®: ${JSON.stringify(event.data).substring(0, 100)}`);
        });

        window.addEventListener('load', () => {
            log('ğŸš€ æµ‹è¯•å·¥å…·å·²å¯åŠ¨');
            log('â³ ç­‰å¾… iframe åŠ è½½...');
        });

        document.getElementById('iframe').addEventListener('load', () => {
            log('âœ… iframe å·²åŠ è½½');
            log('ğŸ’¡ ç­‰å¾… 5 ç§’åè‡ªåŠ¨å‘é€æµ‹è¯•æ¶ˆæ¯...');
            
            setTimeout(() => {
                log('');
                log('è‡ªåŠ¨æµ‹è¯•å¼€å§‹ï¼š');
                sendTestMessage();
                
                setTimeout(() => {
                    if (messageCount === 0) {
                        log('');
                        log('âŒ è­¦å‘Šï¼šæ²¡æœ‰æ”¶åˆ°ä»»ä½•æ¶ˆæ¯ï¼');
                        log('   å¯èƒ½åŸå› ï¼š');
                        log('   1. Scratch ç¼–è¾‘å™¨æ²¡æœ‰è®¾ç½® postMessage ç›‘å¬å™¨');
                        log('   2. æˆ–è€…æ²¡æœ‰å›å¤æ¶ˆæ¯');
                        log('');
                        log('ğŸ’¡ è¿™æ˜¯æ­£å¸¸çš„ï¼Scratch ç¼–è¾‘å™¨å¯èƒ½ä¸å“åº”æœªçŸ¥æ¶ˆæ¯');
                        log('ğŸ’¡ å…³é”®æ˜¯çœ‹æ˜¯å¦æ”¶åˆ° webpack HMR ç›¸å…³æ¶ˆæ¯');
                    } else {
                        log('');
                        log(`âœ… å·²æ”¶åˆ° ${messageCount} æ¡æ¶ˆæ¯`);
                        log('   postMessage é€šä¿¡æ­£å¸¸ï¼');
                    }
                }, 3000);
            }, 5000);
        });
    </script>
</body>
</html>

