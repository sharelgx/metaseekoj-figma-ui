<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç™»å½•çŠ¶æ€è¯Šæ–­å·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        h1 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .status {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .card h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 18px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        
        .status-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        
        .status-item:last-child {
            border-bottom: none;
        }
        
        .label {
            font-weight: 600;
            color: #666;
        }
        
        .value {
            color: #333;
            font-family: monospace;
        }
        
        .success {
            color: #10b981;
            font-weight: bold;
        }
        
        .error {
            color: #ef4444;
            font-weight: bold;
        }
        
        .warning {
            color: #f59e0b;
            font-weight: bold;
        }
        
        .buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5568d3;
        }
        
        .btn-success {
            background: #10b981;
            color: white;
        }
        
        .btn-success:hover {
            background: #059669;
        }
        
        .btn-danger {
            background: #ef4444;
            color: white;
        }
        
        .btn-danger:hover {
            background: #dc2626;
        }
        
        .log {
            background: #1e293b;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .log-entry {
            margin-bottom: 8px;
            padding: 4px;
            border-left: 3px solid #667eea;
            padding-left: 8px;
        }
        
        .log-success {
            border-left-color: #10b981;
        }
        
        .log-error {
            border-left-color: #ef4444;
        }
        
        .log-warning {
            border-left-color: #f59e0b;
        }
        
        .timestamp {
            color: #94a3b8;
            margin-right: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ” Scratch ç¼–è¾‘å™¨ç™»å½•çŠ¶æ€è¯Šæ–­å·¥å…·</h1>
            <p>å®æ—¶ç›‘æ§ç¼–è¾‘å™¨çš„ç™»å½•çŠ¶æ€å’Œç”¨æˆ·ä¿¡æ¯åŒæ­¥</p>
        </div>
        
        <div class="status">
            <div class="card">
                <h2>ğŸ“¡ API çŠ¶æ€</h2>
                <div class="status-item">
                    <span class="label">API å“åº”:</span>
                    <span class="value" id="api-status">æ£€æŸ¥ä¸­...</span>
                </div>
                <div class="status-item">
                    <span class="label">HTTP çŠ¶æ€ç :</span>
                    <span class="value" id="http-code">-</span>
                </div>
                <div class="status-item">
                    <span class="label">å“åº”æ—¶é—´:</span>
                    <span class="value" id="response-time">-</span>
                </div>
                <div class="buttons">
                    <button class="btn-primary" onclick="checkAPI()">ğŸ”„ é‡æ–°æ£€æŸ¥</button>
                </div>
            </div>
            
            <div class="card">
                <h2>ğŸ‘¤ ç”¨æˆ·ä¿¡æ¯</h2>
                <div class="status-item">
                    <span class="label">ç™»å½•çŠ¶æ€:</span>
                    <span class="value" id="login-status">æœªçŸ¥</span>
                </div>
                <div class="status-item">
                    <span class="label">ç”¨æˆ·å:</span>
                    <span class="value" id="username">-</span>
                </div>
                <div class="status-item">
                    <span class="label">çœŸå®å§“å:</span>
                    <span class="value" id="real-name">-</span>
                </div>
                <div class="status-item">
                    <span class="label">å¤´åƒ:</span>
                    <span class="value" id="avatar">-</span>
                </div>
            </div>
            
            <div class="card">
                <h2>ğŸª Cookie çŠ¶æ€</h2>
                <div class="status-item">
                    <span class="label">sessionid:</span>
                    <span class="value" id="cookie-session">-</span>
                </div>
                <div class="status-item">
                    <span class="label">csrftoken:</span>
                    <span class="value" id="cookie-csrf">-</span>
                </div>
                <div class="buttons">
                    <button class="btn-primary" onclick="checkCookies()">ğŸ”„ æ£€æŸ¥ Cookie</button>
                    <button class="btn-danger" onclick="clearCookies()">ğŸ—‘ï¸ æ¸…é™¤ Cookie</button>
                </div>
            </div>
            
            <div class="card">
                <h2>ğŸ¨ Scratch ç¼–è¾‘å™¨</h2>
                <div class="status-item">
                    <span class="label">iframe çŠ¶æ€:</span>
                    <span class="value" id="iframe-status">-</span>
                </div>
                <div class="status-item">
                    <span class="label">VM çŠ¶æ€:</span>
                    <span class="value" id="vm-status">-</span>
                </div>
                <div class="status-item">
                    <span class="label">ç¼–è¾‘å™¨ URL:</span>
                    <span class="value" id="editor-url" style="font-size: 10px;">-</span>
                </div>
                <div class="buttons">
                    <button class="btn-success" onclick="openEditor()">ğŸ“ æ‰“å¼€ç¼–è¾‘å™¨</button>
                </div>
            </div>
        </div>
        
        <div class="card">
            <h2>ğŸ“‹ å®æ—¶æ—¥å¿—</h2>
            <div class="buttons" style="margin-bottom: 10px;">
                <button class="btn-primary" onclick="clearLog()">ğŸ—‘ï¸ æ¸…é™¤æ—¥å¿—</button>
                <button class="btn-success" onclick="startMonitoring()">â–¶ï¸ å¼€å§‹ç›‘æ§</button>
                <button class="btn-danger" onclick="stopMonitoring()">â¸ï¸ åœæ­¢ç›‘æ§</button>
            </div>
            <div class="log" id="log">
                <div class="log-entry">ç­‰å¾…å¼€å§‹...</div>
            </div>
        </div>
    </div>
    
    <script>
        let monitoringInterval = null;
        let requestCount = 0;
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            
            if (type === 'success') entry.className += ' log-success';
            if (type === 'error') entry.className += ' log-error';
            if (type === 'warning') entry.className += ' log-warning';
            
            entry.innerHTML = `<span class="timestamp">[${timestamp}]</span>${message}`;
            
            // æ’å…¥åˆ°é¡¶éƒ¨
            logDiv.insertBefore(entry, logDiv.firstChild);
            
            // é™åˆ¶æ—¥å¿—æ¡æ•°
            if (logDiv.children.length > 100) {
                logDiv.removeChild(logDiv.lastChild);
            }
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '<div class="log-entry">æ—¥å¿—å·²æ¸…é™¤</div>';
        }
        
        async function checkAPI() {
            requestCount++;
            const reqId = requestCount;
            
            log(`ğŸ” [è¯·æ±‚ #${reqId}] å¼€å§‹æ£€æŸ¥ API çŠ¶æ€...`);
            
            const startTime = Date.now();
            
            try {
                const response = await fetch('http://localhost:8086/api/profile/', {
                    credentials: 'include',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                const endTime = Date.now();
                const responseTime = endTime - startTime;
                
                document.getElementById('http-code').textContent = response.status;
                document.getElementById('response-time').textContent = `${responseTime}ms`;
                
                if (response.ok) {
                    const data = await response.json();
                    
                    log(`âœ… [è¯·æ±‚ #${reqId}] API å“åº”æ­£å¸¸ (${responseTime}ms)`, 'success');
                    document.getElementById('api-status').innerHTML = '<span class="success">âœ“ æ­£å¸¸</span>';
                    
                    if (data.error === null && data.data) {
                        const userData = data.data;
                        const realName = userData.real_name || '-';
                        const username = userData.user?.username || '-';
                        const avatar = userData.avatar || '-';
                        
                        document.getElementById('login-status').innerHTML = '<span class="success">âœ“ å·²ç™»å½•</span>';
                        document.getElementById('username').textContent = username;
                        document.getElementById('real-name').textContent = realName;
                        document.getElementById('avatar').textContent = avatar;
                        
                        log(`ğŸ‘¤ [è¯·æ±‚ #${reqId}] ç”¨æˆ·å·²ç™»å½•: ${realName} (${username})`, 'success');
                    } else {
                        document.getElementById('login-status').innerHTML = '<span class="error">âœ— æœªç™»å½•</span>';
                        document.getElementById('username').textContent = '-';
                        document.getElementById('real-name').textContent = '-';
                        document.getElementById('avatar').textContent = '-';
                        
                        log(`âš ï¸ [è¯·æ±‚ #${reqId}] ç”¨æˆ·æœªç™»å½•`, 'warning');
                    }
                } else {
                    document.getElementById('api-status').innerHTML = '<span class="error">âœ— å¼‚å¸¸</span>';
                    log(`âŒ [è¯·æ±‚ #${reqId}] API å“åº”å¼‚å¸¸: HTTP ${response.status}`, 'error');
                }
            } catch (error) {
                document.getElementById('api-status').innerHTML = '<span class="error">âœ— é”™è¯¯</span>';
                log(`âŒ [è¯·æ±‚ #${reqId}] API è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        function checkCookies() {
            log('ğŸª æ£€æŸ¥ Cookie...');
            
            const cookies = document.cookie.split(';').reduce((acc, cookie) => {
                const [key, value] = cookie.trim().split('=');
                acc[key] = value;
                return acc;
            }, {});
            
            const sessionid = cookies.sessionid || 'æœªæ‰¾åˆ°';
            const csrftoken = cookies.csrftoken || 'æœªæ‰¾åˆ°';
            
            document.getElementById('cookie-session').textContent = sessionid.substring(0, 20) + '...';
            document.getElementById('cookie-csrf').textContent = csrftoken.substring(0, 20) + '...';
            
            if (sessionid !== 'æœªæ‰¾åˆ°') {
                log(`âœ… sessionid å­˜åœ¨: ${sessionid.substring(0, 20)}...`, 'success');
            } else {
                log('âš ï¸ sessionid ä¸å­˜åœ¨ï¼å¯èƒ½éœ€è¦é‡æ–°ç™»å½•', 'warning');
            }
            
            if (csrftoken !== 'æœªæ‰¾åˆ°') {
                log(`âœ… csrftoken å­˜åœ¨: ${csrftoken.substring(0, 20)}...`, 'success');
            } else {
                log('âš ï¸ csrftoken ä¸å­˜åœ¨ï¼', 'warning');
            }
        }
        
        function clearCookies() {
            if (!confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰ Cookie å—ï¼Ÿè¿™å°†ç™»å‡ºå½“å‰ç”¨æˆ·ã€‚')) {
                return;
            }
            
            log('ğŸ—‘ï¸ æ¸…é™¤ Cookie...', 'warning');
            
            document.cookie.split(';').forEach(cookie => {
                const name = cookie.split('=')[0].trim();
                document.cookie = `${name}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;`;
            });
            
            log('âœ… Cookie å·²æ¸…é™¤', 'success');
            checkCookies();
        }
        
        function checkEditor() {
            const editorUrl = 'http://localhost:8081/classroom/scratch/editor';
            document.getElementById('editor-url').textContent = editorUrl;
            
            fetch('http://localhost:8601/')
                .then(response => {
                    if (response.ok) {
                        document.getElementById('iframe-status').innerHTML = '<span class="success">âœ“ è¿è¡Œä¸­</span>';
                        log('âœ… Scratch ç¼–è¾‘å™¨è¿è¡Œæ­£å¸¸', 'success');
                    } else {
                        document.getElementById('iframe-status').innerHTML = '<span class="error">âœ— å¼‚å¸¸</span>';
                        log('âŒ Scratch ç¼–è¾‘å™¨å“åº”å¼‚å¸¸', 'error');
                    }
                })
                .catch(error => {
                    document.getElementById('iframe-status').innerHTML = '<span class="error">âœ— ç¦»çº¿</span>';
                    log('âŒ Scratch ç¼–è¾‘å™¨æ— æ³•è®¿é—®', 'error');
                });
        }
        
        function openEditor() {
            log('ğŸ“ æ‰“å¼€ Scratch ç¼–è¾‘å™¨...');
            window.open('http://localhost:8081/classroom/scratch/editor', '_blank');
        }
        
        function startMonitoring() {
            if (monitoringInterval) {
                log('âš ï¸ ç›‘æ§å·²åœ¨è¿è¡Œä¸­', 'warning');
                return;
            }
            
            log('â–¶ï¸ å¼€å§‹ç›‘æ§...', 'success');
            checkAPI();
            checkCookies();
            checkEditor();
            
            monitoringInterval = setInterval(() => {
                checkAPI();
            }, 3000);
        }
        
        function stopMonitoring() {
            if (!monitoringInterval) {
                log('âš ï¸ ç›‘æ§æœªè¿è¡Œ', 'warning');
                return;
            }
            
            clearInterval(monitoringInterval);
            monitoringInterval = null;
            log('â¸ï¸ ç›‘æ§å·²åœæ­¢', 'success');
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥
        window.addEventListener('load', () => {
            log('ğŸš€ è¯Šæ–­å·¥å…·å·²åŠ è½½');
            setTimeout(() => {
                startMonitoring();
            }, 500);
        });
        
        // é¡µé¢å¸è½½æ—¶åœæ­¢ç›‘æ§
        window.addEventListener('beforeunload', () => {
            stopMonitoring();
        });
    </script>
</body>
</html>

