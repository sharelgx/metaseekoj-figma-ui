<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>VM çŠ¶æ€æ£€æŸ¥</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            padding: 20px;
            background: #000;
            color: #0f0;
        }
        .status {
            background: #1a1a1a;
            border: 2px solid #0a0;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        .item {
            padding: 10px;
            margin: 5px 0;
            background: #0a0a0a;
            border-left: 4px solid #0a0;
        }
        .success { border-left-color: #0f0; color: #0f0; }
        .error { border-left-color: #f00; color: #f00; }
        .warning { border-left-color: #ff0; color: #ff0; }
        button {
            background: #0a0;
            color: #000;
            border: none;
            padding: 15px 30px;
            margin: 10px 5px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 16px;
            font-weight: bold;
        }
        button:hover {
            background: #0f0;
        }
        iframe {
            width: 100%;
            height: 500px;
            border: 2px solid #0a0;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>ğŸ”¬ Scratch VM çŠ¶æ€æ£€æŸ¥å·¥å…·</h1>
    
    <div>
        <button onclick="checkStatus()">ğŸ” æ£€æŸ¥ VM çŠ¶æ€</button>
        <button onclick="tryExport()">ğŸ“¤ å°è¯•å¯¼å‡ºæ•°æ®</button>
        <button onclick="location.reload()">ğŸ”„ åˆ·æ–°é¡µé¢</button>
    </div>

    <div class="status" id="status"></div>

    <iframe id="iframe" src="http://localhost:8601/"></iframe>

    <script>
        let iframe = null;
        let checkCount = 0;

        function updateStatus(html) {
            document.getElementById('status').innerHTML = html;
        }

        function checkStatus() {
            checkCount++;
            iframe = document.getElementById('iframe');
            
            let html = `<h2>æ£€æŸ¥ #${checkCount} (${new Date().toLocaleTimeString()})</h2>`;
            
            if (!iframe) {
                html += `<div class="item error">âŒ iframe å…ƒç´ ä¸å­˜åœ¨</div>`;
                updateStatus(html);
                return;
            }
            
            html += `<div class="item success">âœ… iframe å…ƒç´ å­˜åœ¨</div>`;
            
            if (!iframe.contentWindow) {
                html += `<div class="item error">âŒ iframe.contentWindow ä¸å¯è®¿é—®</div>`;
                updateStatus(html);
                return;
            }
            
            html += `<div class="item success">âœ… iframe.contentWindow å¯è®¿é—®</div>`;
            
            // å°è¯•æ£€æŸ¥å‡½æ•°ï¼ˆä¼šå¤±è´¥ï¼Œå› ä¸ºè·¨åŸŸï¼‰
            try {
                const exportFn = iframe.contentWindow.scratchExportProjectData;
                if (exportFn) {
                    html += `<div class="item success">âœ… scratchExportProjectData å­˜åœ¨ï¼ˆåŒåŸŸï¼‰</div>`;
                } else {
                    html += `<div class="item error">âŒ scratchExportProjectData ä¸å­˜åœ¨</div>`;
                }
            } catch (e) {
                html += `<div class="item warning">âš ï¸ è·¨åŸŸé™åˆ¶ï¼Œæ— æ³•ç›´æ¥æ£€æŸ¥ï¼ˆæ­£å¸¸ç°è±¡ï¼‰</div>`;
                html += `<div class="item warning">   é”™è¯¯: ${e.message}</div>`;
                html += `<div class="item">ğŸ’¡ å°†é€šè¿‡ postMessage æµ‹è¯•...</div>`;
            }
            
            updateStatus(html);
        }

        function tryExport() {
            iframe = document.getElementById('iframe');
            
            if (!iframe || !iframe.contentWindow) {
                updateStatus('<div class="item error">âŒ iframe æœªå‡†å¤‡å¥½</div>');
                return;
            }
            
            updateStatus(`
                <h2>å¯¼å‡ºæµ‹è¯•</h2>
                <div class="item">ğŸ“¨ æ­£åœ¨å‘é€å¯¼å‡ºè¯·æ±‚...</div>
            `);
            
            // è®¾ç½®å“åº”ç›‘å¬å™¨
            const responseHandler = (event) => {
                if (!event.origin.includes('localhost')) return;
                
                if (event.data && event.data.type === 'EXPORT_PROJECT_RESPONSE') {
                    const data = event.data.data;
                    const dataSize = JSON.stringify(data).length;
                    
                    updateStatus(`
                        <h2>å¯¼å‡ºæµ‹è¯•</h2>
                        <div class="item success">âœ… å¯¼å‡ºæˆåŠŸï¼</div>
                        <div class="item">ğŸ“¦ æ•°æ®å¤§å°: ${dataSize} å­—èŠ‚</div>
                        <div class="item">ğŸ¯ å¯¹è±¡æ•°é‡: ${data.targets?.length || 0}</div>
                        <div class="item">ğŸ“Š æ‰©å±•æ•°é‡: ${data.extensions?.length || 0}</div>
                        <div class="item">ğŸ”§ meta.semver: ${data.meta?.semver || 'N/A'}</div>
                    `);
                    
                    window.removeEventListener('message', responseHandler);
                }
            };
            
            window.addEventListener('message', responseHandler);
            
            // å‘é€å¯¼å‡ºè¯·æ±‚
            iframe.contentWindow.postMessage({
                type: 'EXPORT_PROJECT_REQUEST'
            }, '*');
            
            // 5ç§’è¶…æ—¶
            setTimeout(() => {
                window.removeEventListener('message', responseHandler);
            }, 5000);
        }

        // é¡µé¢åŠ è½½å®Œæˆ
        window.addEventListener('load', () => {
            updateStatus(`
                <div class="item">ğŸš€ å·¥å…·å·²å¯åŠ¨</div>
                <div class="item">â³ ç­‰å¾… iframe åŠ è½½ï¼ˆçº¦ 5 ç§’ï¼‰...</div>
            `);
            
            setTimeout(() => {
                updateStatus(`
                    <div class="item success">âœ… iframe åº”è¯¥å·²ç»åŠ è½½å®Œæˆ</div>
                    <div class="item">ğŸ’¡ ç°åœ¨å¯ä»¥ç‚¹å‡»"æ£€æŸ¥ VM çŠ¶æ€"æŒ‰é’®</div>
                `);
            }, 5000);
        });

        // ç›‘å¬ iframe åŠ è½½
        document.getElementById('iframe').addEventListener('load', () => {
            updateStatus(`
                <div class="item success">âœ… iframe å†…å®¹å·²åŠ è½½</div>
                <div class="item">â³ ç­‰å¾… 3 ç§’è®© VM åˆå§‹åŒ–...</div>
            `);
            
            setTimeout(() => {
                checkStatus();
            }, 3000);
        });
    </script>
</body>
</html>

