<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>ç¼–è¾‘å™¨è¯Šæ–­å·¥å…·</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #000; color: #0f0; }
        .status { padding: 10px; margin: 5px 0; border-left: 4px solid #666; background: #0a0a0a; }
        .ok { border-left-color: #0f0; color: #0f0; }
        .error { border-left-color: #f00; color: #f00; }
        button { background: #0a0; color: #000; border: none; padding: 15px 30px; margin: 10px 5px; cursor: pointer; border-radius: 4px; font-size: 16px; font-weight: bold; }
        button:hover { background: #0f0; }
        iframe { width: 100%; height: 600px; border: 2px solid #0a0; margin-top: 20px; }
    </style>
</head>
<body>
    <h1>ğŸ”¬ ç¼–è¾‘å™¨çŠ¶æ€å®æ—¶è¯Šæ–­</h1>
    <button onclick="checkStatus()">ğŸ” æ£€æŸ¥çŠ¶æ€</button>
    <button onclick="testSave()">ğŸ’¾ æµ‹è¯•ä¿å­˜åŠŸèƒ½</button>
    <button onclick="location.reload()">ğŸ”„ åˆ·æ–°</button>
    
    <div id="result"></div>
    
    <h2>ç¼–è¾‘å™¨ iframe</h2>
    <iframe id="iframe" src="http://localhost:8081/classroom/scratch/editor"></iframe>

    <script>
        const result = document.getElementById('result');
        let checkInterval = null;

        function updateResult(html) {
            result.innerHTML = html;
        }

        function checkStatus() {
            const iframe = document.getElementById('iframe');
            let html = `<h2>çŠ¶æ€æ£€æŸ¥ [${new Date().toLocaleTimeString()}]</h2>`;
            
            // ç”±äºè·¨åŸŸï¼Œæˆ‘ä»¬é€šè¿‡ postMessage æ¥æ£€æŸ¥
            html += `<div class="status">ğŸ“¨ é€šè¿‡ postMessage æ£€æŸ¥çŠ¶æ€...</div>`;
            
            // å‘é€æ£€æŸ¥è¯·æ±‚
            iframe.contentWindow.postMessage({ type: 'CHECK_STATUS' }, '*');
            
            updateResult(html);
            
            // è®¾ç½®å“åº”ç›‘å¬
            const responseHandler = (event) => {
                if (!event.origin.includes('localhost')) return;
                
                if (event.data && event.data.type === 'STATUS_RESPONSE') {
                    window.removeEventListener('message', responseHandler);
                    
                    const status = event.data.data;
                    html += `<div class="status ${status.vmReady ? 'ok' : 'error'}">
                        VM çŠ¶æ€: ${status.vmReady ? 'âœ… å·²åˆå§‹åŒ–' : 'âŒ æœªåˆå§‹åŒ–'}
                    </div>`;
                    html += `<div class="status ${status.exportFn ? 'ok' : 'error'}">
                        å¯¼å‡ºå‡½æ•°: ${status.exportFn ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨'}
                    </div>`;
                    html += `<div class="status ${status.loadFn ? 'ok' : 'error'}">
                        åŠ è½½å‡½æ•°: ${status.loadFn ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨'}
                    </div>`;
                    html += `<div class="status ${status.userLoggedIn ? 'ok' : 'error'}">
                        ç™»å½•çŠ¶æ€: ${status.userLoggedIn ? 'âœ… å·²ç™»å½•' : 'âŒ æœªç™»å½•'}
                    </div>`;
                    
                    updateResult(html);
                }
            };
            
            window.addEventListener('message', responseHandler);
            
            // 5ç§’è¶…æ—¶
            setTimeout(() => {
                window.removeEventListener('message', responseHandler);
            }, 5000);
        }

        function testSave() {
            const iframe = document.getElementById('iframe');
            let html = `<h2>ä¿å­˜åŠŸèƒ½æµ‹è¯• [${new Date().toLocaleTimeString()}]</h2>`;
            html += `<div class="status">ğŸ“¨ è¯·æ±‚å¯¼å‡ºé¡¹ç›®æ•°æ®...</div>`;
            updateResult(html);
            
            // è¯·æ±‚å¯¼å‡º
            iframe.contentWindow.postMessage({ type: 'EXPORT_PROJECT_REQUEST' }, '*');
            
            const exportHandler = (event) => {
                if (!event.origin.includes('localhost')) return;
                
                if (event.data && event.data.type === 'EXPORT_PROJECT_RESPONSE') {
                    window.removeEventListener('message', exportHandler);
                    
                    const data = event.data.data;
                    if (data) {
                        const size = JSON.stringify(data).length;
                        html += `<div class="status ok">âœ… å¯¼å‡ºæˆåŠŸï¼</div>`;
                        html += `<div class="status">æ•°æ®å¤§å°: ${size} å­—èŠ‚</div>`;
                        html += `<div class="status">å¯¹è±¡æ•°é‡: ${data.targets?.length || 0}</div>`;
                        html += `<div class="status ok">ğŸ’¾ ä¿å­˜åŠŸèƒ½æ­£å¸¸ï¼</div>`;
                    } else {
                        html += `<div class="status error">âŒ å¯¼å‡ºå¤±è´¥ï¼šæ•°æ®ä¸ºç©º</div>`;
                    }
                    
                    updateResult(html);
                }
            };
            
            window.addEventListener('message', exportHandler);
            
            setTimeout(() => {
                window.removeEventListener('message', exportHandler);
            }, 5000);
        }

        // ç›‘å¬ VM å°±ç»ªæ¶ˆæ¯
        window.addEventListener('message', (event) => {
            if (!event.origin.includes('localhost')) return;
            
            if (event.data && event.data.type === 'SCRATCH_VM_READY') {
                updateResult(`
                    <div class="status ok">
                        âœ… æ”¶åˆ° SCRATCH_VM_READY æ¶ˆæ¯ï¼
                        <br>æ—¶é—´: ${event.data.data.timestamp}
                    </div>
                `);
            }
        });

        // è‡ªåŠ¨å®šæœŸæ£€æŸ¥
        window.addEventListener('load', () => {
            updateResult('<div class="status">â³ ç­‰å¾… iframe åŠ è½½...</div>');
            
            setTimeout(() => {
                updateResult('<div class="status">â„¹ï¸ iframe å·²åŠ è½½ï¼Œç‚¹å‡»"æ£€æŸ¥çŠ¶æ€"æŒ‰é’®</div>');
            }, 8000);
        });
    </script>
</body>
</html>

