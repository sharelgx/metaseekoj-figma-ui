<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¿å­˜/åŠ è½½æµç¨‹è‡ªåŠ¨åŒ–æµ‹è¯•</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1400px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #007bff;
            padding-bottom: 10px;
        }
        .test-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
        }
        button:hover {
            background: #0056b3;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,123,255,0.3);
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        .log {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 6px;
            height: 300px;
            overflow-y: auto;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
            line-height: 1.5;
        }
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .status-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #007bff;
        }
        .status-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }
        .status-value {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .warning { color: #ffc107; }
        .info { color: #17a2b8; }
        .metric {
            display: inline-block;
            background: #e9ecef;
            padding: 4px 8px;
            border-radius: 4px;
            margin: 2px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>ğŸ§ª ä¿å­˜/åŠ è½½æµç¨‹æ€§èƒ½æµ‹è¯•</h1>
    
    <div class="test-section">
        <h2>ğŸ“Š å®æ—¶çŠ¶æ€</h2>
        <div class="status-grid">
            <div class="status-card">
                <div class="status-label">iframe çŠ¶æ€</div>
                <div class="status-value" id="iframeStatus">æ£€æŸ¥ä¸­...</div>
            </div>
            <div class="status-card">
                <div class="status-label">VM çŠ¶æ€</div>
                <div class="status-value" id="vmStatus">æ£€æŸ¥ä¸­...</div>
            </div>
            <div class="status-card">
                <div class="status-label">å½“å‰ç§¯æœ¨æ•°</div>
                <div class="status-value" id="blockCount">-</div>
            </div>
            <div class="status-card">
                <div class="status-label">é¡¹ç›® ID</div>
                <div class="status-value" id="projectId">-</div>
            </div>
        </div>
    </div>
    
    <div class="test-section">
        <h2>ğŸ® æµ‹è¯•æ§åˆ¶</h2>
        <div class="test-controls">
            <button onclick="checkStatus()">æ£€æŸ¥çŠ¶æ€</button>
            <button onclick="testSave()">æµ‹è¯•ä¿å­˜</button>
            <button onclick="testLoad()">æµ‹è¯•åŠ è½½</button>
            <button onclick="runFullTest()">å®Œæ•´æµ‹è¯•</button>
            <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
        </div>
    </div>
    
    <div class="test-section">
        <h2>ğŸ“ æµ‹è¯•æ—¥å¿—</h2>
        <div class="log" id="log"></div>
    </div>
    
    <div class="test-section">
        <h2>ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡</h2>
        <div id="metrics"></div>
    </div>

    <script>
        const logDiv = document.getElementById('log');
        let metrics = {
            saveTime: [],
            loadTime: [],
            exportTime: [],
            thumbnailTime: []
        };
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const className = type;
            logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function clearLog() {
            logDiv.innerHTML = '';
            log('æ—¥å¿—å·²æ¸…ç©º', 'info');
        }
        
        function updateMetrics() {
            const metricsDiv = document.getElementById('metrics');
            const avg = (arr) => arr.length ? (arr.reduce((a,b)=>a+b,0)/arr.length).toFixed(2) : '-';
            
            metricsDiv.innerHTML = `
                <span class="metric">å¹³å‡ä¿å­˜æ—¶é—´: ${avg(metrics.saveTime)}ms</span>
                <span class="metric">å¹³å‡åŠ è½½æ—¶é—´: ${avg(metrics.loadTime)}ms</span>
                <span class="metric">å¹³å‡å¯¼å‡ºæ—¶é—´: ${avg(metrics.exportTime)}ms</span>
                <span class="metric">å¹³å‡æˆªå›¾æ—¶é—´: ${avg(metrics.thumbnailTime)}ms</span>
                <span class="metric">æµ‹è¯•æ¬¡æ•°: ${metrics.saveTime.length}</span>
            `;
        }
        
        async function checkStatus() {
            log('ğŸ” æ£€æŸ¥ç³»ç»ŸçŠ¶æ€...', 'info');
            
            // æ£€æŸ¥ iframe
            const editorWindow = window.opener || window.parent;
            if (!editorWindow || editorWindow === window) {
                log('âŒ æ­¤é¡µé¢éœ€è¦ä»ç¼–è¾‘å™¨é¡µé¢æ‰“å¼€', 'error');
                document.getElementById('iframeStatus').textContent = 'æœªè¿æ¥';
                return false;
            }
            
            try {
                // å°è¯•è®¿é—®ç¼–è¾‘å™¨é¡µé¢çš„ DOM
                const iframe = editorWindow.document.querySelector('iframe[src*="8601"]');
                document.getElementById('iframeStatus').textContent = iframe ? 'âœ… å°±ç»ª' : 'âŒ æœªæ‰¾åˆ°';
                
                if (!iframe) {
                    log('âŒ æœªæ‰¾åˆ° Scratch iframe', 'error');
                    return false;
                }
                
                // æ£€æŸ¥ VM
                const vm = iframe.contentWindow?.vm;
                document.getElementById('vmStatus').textContent = vm ? 'âœ… å°±ç»ª' : 'âŒ æœªåˆå§‹åŒ–';
                
                if (vm) {
                    const blocks = vm.runtime?.targets?.[0]?.blocks?._blocks?.size || 0;
                    document.getElementById('blockCount').textContent = blocks;
                    log(`âœ… VM å·²å°±ç»ªï¼Œå½“å‰ç§¯æœ¨æ•°: ${blocks}`, 'success');
                } else {
                    log('âš ï¸ VM æœªåˆå§‹åŒ–', 'warning');
                }
                
                // è·å–é¡¹ç›® ID
                const url = editorWindow.location.pathname;
                const match = url.match(/\/edit\/(\d+)/);
                if (match) {
                    document.getElementById('projectId').textContent = match[1];
                    log(`ğŸ“‹ é¡¹ç›® ID: ${match[1]}`, 'info');
                }
                
                return true;
            } catch (e) {
                log('âŒ æ— æ³•è®¿é—®ç¼–è¾‘å™¨ï¼ˆå¯èƒ½æ˜¯è·¨åŸŸé™åˆ¶ï¼‰: ' + e.message, 'error');
                return false;
            }
        }
        
        async function testSave() {
            log('ğŸ’¾ å¼€å§‹ä¿å­˜æµ‹è¯•...', 'info');
            const startTime = performance.now();
            
            const editorWindow = window.opener || window.parent;
            if (!editorWindow) {
                log('âŒ æœªè¿æ¥åˆ°ç¼–è¾‘å™¨', 'error');
                return;
            }
            
            try {
                // è§¦å‘ä¿å­˜
                if (editorWindow.scratchSaveHandler) {
                    log('ğŸ“¨ è°ƒç”¨ä¿å­˜å¤„ç†å™¨...', 'info');
                    await editorWindow.scratchSaveHandler();
                    
                    const elapsed = performance.now() - startTime;
                    metrics.saveTime.push(elapsed);
                    updateMetrics();
                    
                    log(`âœ… ä¿å­˜å®Œæˆï¼è€—æ—¶: ${elapsed.toFixed(0)}ms`, 'success');
                } else {
                    log('âŒ ä¿å­˜å¤„ç†å™¨ä¸å­˜åœ¨', 'error');
                }
            } catch (e) {
                log('âŒ ä¿å­˜å¤±è´¥: ' + e.message, 'error');
            }
        }
        
        async function testLoad() {
            log('ğŸ“‚ å¼€å§‹åŠ è½½æµ‹è¯•...', 'info');
            const startTime = performance.now();
            
            log('ğŸ’¡ è¯·æ‰‹åŠ¨åˆ·æ–°ç¼–è¾‘å™¨é¡µé¢è¿›è¡ŒåŠ è½½æµ‹è¯•', 'warning');
            log('   æˆ–å…³é—­æ­¤çª—å£åé‡æ–°æ‰“å¼€ç¼–è¾‘å™¨', 'info');
        }
        
        async function runFullTest() {
            log('ğŸš€ å¼€å§‹å®Œæ•´æµ‹è¯•æµç¨‹...', 'info');
            log('â”'.repeat(50), 'info');
            
            if (!await checkStatus()) {
                log('âŒ çŠ¶æ€æ£€æŸ¥å¤±è´¥ï¼Œä¸­æ­¢æµ‹è¯•', 'error');
                return;
            }
            
            log('â³ ç­‰å¾… 2 ç§’åå¼€å§‹æµ‹è¯•...', 'info');
            await new Promise(r => setTimeout(r, 2000));
            
            // æµ‹è¯• 1: ä¿å­˜
            log('ğŸ“‹ æµ‹è¯• 1/3: ä¿å­˜åŠŸèƒ½', 'info');
            await testSave();
            
            await new Promise(r => setTimeout(r, 1000));
            
            // æµ‹è¯• 2: å¯¼å‡ºæ€§èƒ½
            log('ğŸ“‹ æµ‹è¯• 2/3: å¯¼å‡ºæ€§èƒ½', 'info');
            const exportStart = performance.now();
            const editorWindow = window.opener || window.parent;
            const iframe = editorWindow.document.querySelector('iframe[src*="8601"]');
            
            if (iframe?.contentWindow) {
                iframe.contentWindow.postMessage({ type: 'EXPORT_PROJECT_REQUEST' }, 'http://localhost:8601');
                
                const handler = (event) => {
                    if (event.data?.type === 'EXPORT_PROJECT_RESPONSE') {
                        const elapsed = performance.now() - exportStart;
                        metrics.exportTime.push(elapsed);
                        updateMetrics();
                        log(`âœ… å¯¼å‡ºå®Œæˆï¼è€—æ—¶: ${elapsed.toFixed(0)}ms`, 'success');
                        window.removeEventListener('message', handler);
                    }
                };
                window.addEventListener('message', handler);
                
                setTimeout(() => {
                    window.removeEventListener('message', handler);
                    log('â° å¯¼å‡ºè¶…æ—¶', 'warning');
                }, 5000);
            }
            
            await new Promise(r => setTimeout(r, 2000));
            
            log('â”'.repeat(50), 'info');
            log('âœ… å®Œæ•´æµ‹è¯•å®Œæˆï¼', 'success');
            log('ğŸ“Š æŸ¥çœ‹æ€§èƒ½æŒ‡æ ‡äº†è§£è¯¦ç»†æ•°æ®', 'info');
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥çŠ¶æ€
        window.onload = () => {
            log('ğŸš€ æµ‹è¯•å·¥å…·å·²å°±ç»ª', 'success');
            log('ğŸ’¡ æç¤ºï¼šæ­¤é¡µé¢éœ€è¦ä»ç¼–è¾‘å™¨é¡µé¢æ‰“å¼€ï¼ˆå³é”®æ–°çª—å£ï¼‰', 'info');
            log('ğŸ’¡ æˆ–åœ¨ç¼–è¾‘å™¨æ§åˆ¶å°è¿è¡Œ: window.open("/test-save-load-flow.html")', 'info');
            
            setTimeout(checkStatus, 1000);
        };
    </script>
</body>
</html>


