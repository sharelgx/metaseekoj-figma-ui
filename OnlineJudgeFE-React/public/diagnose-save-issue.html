<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scratch ä¿å­˜é—®é¢˜è¯Šæ–­å·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
        }

        .section h2 {
            font-size: 20px;
            margin-bottom: 15px;
            color: #667eea;
        }

        .button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .button:active {
            transform: translateY(0);
        }

        .output {
            background: #f5f5f5;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 15px;
            margin-top: 15px;
            font-family: "Courier New", monospace;
            font-size: 14px;
            line-height: 1.6;
            max-height: 400px;
            overflow-y: auto;
        }

        .output pre {
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }

        .status.success {
            background: #4caf50;
            color: white;
        }

        .status.error {
            background: #f44336;
            color: white;
        }

        .status.warning {
            background: #ff9800;
            color: white;
        }

        .instruction {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }

        .instruction strong {
            display: block;
            margin-bottom: 5px;
            color: #856404;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ” Scratch ä¿å­˜é—®é¢˜è¯Šæ–­å·¥å…·</h1>
            <p>è‡ªåŠ¨æ£€æµ‹ VM çŠ¶æ€ã€ä¿å­˜æµç¨‹å’Œæ•°æ®å®Œæ•´æ€§</p>
        </div>

        <div class="content">
            <div class="instruction">
                <strong>ğŸ“‹ ä½¿ç”¨è¯´æ˜ï¼š</strong>
                1. ç¡®ä¿å·²ç™»å½•ï¼ˆæ˜¾ç¤º"æŸ³è€å¸ˆ"å¤´åƒï¼‰<br>
                2. åœ¨ Scratch ç¼–è¾‘å™¨ä¸­æ·»åŠ ä¸€äº›ç§¯æœ¨<br>
                3. ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®è¿›è¡Œè¯Šæ–­
            </div>

            <div class="section">
                <h2>ç¬¬1æ­¥ï¼šæ£€æŸ¥ VM çŠ¶æ€</h2>
                <button class="button" onclick="checkVMStatus()">ğŸ” æ£€æŸ¥ VM</button>
                <div id="vm-output" class="output" style="display:none;"></div>
            </div>

            <div class="section">
                <h2>ç¬¬2æ­¥ï¼šå¯¼å‡ºé¡¹ç›®æ•°æ®</h2>
                <button class="button" onclick="exportProjectData()">ğŸ“¤ å¯¼å‡ºæ•°æ®</button>
                <div id="export-output" class="output" style="display:none;"></div>
            </div>

            <div class="section">
                <h2>ç¬¬3æ­¥ï¼šæµ‹è¯•å®Œæ•´ä¿å­˜æµç¨‹</h2>
                <button class="button" onclick="testSaveFlow()">ğŸ’¾ æµ‹è¯•ä¿å­˜</button>
                <div id="save-output" class="output" style="display:none;"></div>
            </div>

            <div class="section">
                <h2>ç¬¬4æ­¥ï¼šæŸ¥çœ‹æˆ‘çš„é¡¹ç›®åˆ—è¡¨</h2>
                <button class="button" onclick="checkMyProjects()">ğŸ“‹ æŸ¥çœ‹é¡¹ç›®</button>
                <div id="projects-output" class="output" style="display:none;"></div>
            </div>

            <div class="section">
                <h2>ä¸€é”®è¯Šæ–­</h2>
                <button class="button" onclick="runFullDiagnosis()" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">ğŸš€ è¿è¡Œå®Œæ•´è¯Šæ–­</button>
                <div id="full-output" class="output" style="display:none;"></div>
            </div>
        </div>
    </div>

    <script>
        const EDITOR_URL = 'http://localhost:8601';
        const API_BASE = 'http://localhost:8086/api';

        function log(elementId, message, clear = false) {
            const output = document.getElementById(elementId);
            output.style.display = 'block';
            if (clear) {
                output.innerHTML = '';
            }
            output.innerHTML += message + '<br>';
            output.scrollTop = output.scrollHeight;
        }

        async function checkVMStatus() {
            const output = 'vm-output';
            log(output, '=' .repeat(60), true);
            log(output, 'ğŸ” æ£€æŸ¥ iframe ä¸­çš„ VM çŠ¶æ€');
            log(output, '=' .repeat(60));

            const iframe = document.querySelector('iframe[src*="8601"]');
            if (!iframe) {
                log(output, '<span class="status error">ERROR</span> æœªæ‰¾åˆ° Scratch ç¼–è¾‘å™¨ iframe');
                return null;
            }

            log(output, '<span class="status success">OK</span> iframe å·²æ‰¾åˆ°');

            try {
                const iframeWindow = iframe.contentWindow;
                const vm = iframeWindow.__scratchVM;

                if (!vm) {
                    log(output, '<span class="status error">ERROR</span> VM å®ä¾‹ä¸å­˜åœ¨');
                    return null;
                }

                log(output, '<span class="status success">OK</span> VM å®ä¾‹å­˜åœ¨');

                const targets = vm.runtime.targets;
                const totalBlocks = targets.reduce((sum, target) => 
                    sum + Object.keys(target.blocks._blocks || {}).length, 0);

                log(output, `ğŸ“Š Targets æ•°é‡: ${targets.length}`);
                log(output, `ğŸ“Š æ€»ç§¯æœ¨æ•°é‡: ${totalBlocks}`);

                if (totalBlocks === 0) {
                    log(output, '<span class="status warning">WARNING</span> VM ä¸­æ²¡æœ‰ç§¯æœ¨ï¼');
                    log(output, 'ğŸ’¡ è¯·å…ˆåœ¨ç¼–è¾‘å™¨ä¸­æ·»åŠ ä¸€äº›ç§¯æœ¨');
                } else {
                    log(output, `<span class="status success">OK</span> VM ä¸­æœ‰ ${totalBlocks} ä¸ªç§¯æœ¨`);
                }

                log(output, '=' .repeat(60));
                return { vm, totalBlocks };
            } catch (error) {
                log(output, `<span class="status error">ERROR</span> æ— æ³•è®¿é—® VM: ${error.message}`);
                log(output, 'ğŸ’¡ å¯èƒ½æ˜¯è·¨åŸŸé—®é¢˜ï¼Œç¡®ä¿ iframe åœ¨åŒä¸€åŸŸåä¸‹');
                return null;
            }
        }

        async function exportProjectData() {
            const output = 'export-output';
            log(output, '=' .repeat(60), true);
            log(output, 'ğŸ“¤ å¯¼å‡ºé¡¹ç›®æ•°æ®');
            log(output, '=' .repeat(60));

            const vmStatus = await checkVMStatus();
            if (!vmStatus) {
                log(output, '<span class="status error">ERROR</span> VM æ£€æŸ¥å¤±è´¥ï¼Œæ— æ³•å¯¼å‡º');
                return null;
            }

            const { vm } = vmStatus;

            try {
                const projectData = vm.toJSON();
                const dataSize = JSON.stringify(projectData).length;

                log(output, `<span class="status success">OK</span> å¯¼å‡ºæˆåŠŸ`);
                log(output, `ğŸ“¦ æ•°æ®å¤§å°: ${dataSize} å­—èŠ‚`);

                if (projectData.targets) {
                    const exportedBlocks = projectData.targets.reduce((sum, target) => 
                        sum + Object.keys(target.blocks || {}).length, 0);
                    log(output, `ğŸ“Š å¯¼å‡ºæ•°æ®ä¸­ç§¯æœ¨æ•°é‡: ${exportedBlocks}`);

                    if (exportedBlocks === 0) {
                        log(output, '<span class="status error">ERROR</span> å¯¼å‡ºçš„æ•°æ®ä¸­æ²¡æœ‰ç§¯æœ¨ï¼');
                    } else {
                        log(output, `<span class="status success">OK</span> æˆåŠŸå¯¼å‡º ${exportedBlocks} ä¸ªç§¯æœ¨`);
                    }
                }

                log(output, '=' .repeat(60));
                return projectData;
            } catch (error) {
                log(output, `<span class="status error">ERROR</span> å¯¼å‡ºå¤±è´¥: ${error.message}`);
                return null;
            }
        }

        async function testSaveFlow() {
            const output = 'save-output';
            log(output, '=' .repeat(60), true);
            log(output, 'ğŸ’¾ æµ‹è¯•ä¿å­˜æµç¨‹');
            log(output, '=' .repeat(60));

            const projectData = await exportProjectData();
            if (!projectData) {
                log(output, '<span class="status error">ERROR</span> æ— æ³•å¯¼å‡ºé¡¹ç›®æ•°æ®');
                return;
            }

            log(output, 'ğŸ“¤ å‡†å¤‡å‘é€åˆ°åç«¯...');
            log(output, `ğŸ“¦ payload.data_json ç±»å‹: ${typeof projectData}`);

            // è¿™é‡Œä¸å®é™…å‘é€ï¼Œåªæ˜¯æ¨¡æ‹Ÿ
            log(output, '<span class="status warning">INFO</span> è¿™æ˜¯æ¨¡æ‹Ÿæµ‹è¯•ï¼Œä¸ä¼šçœŸæ­£ä¿å­˜');
            log(output, 'ğŸ’¡ å®é™…ä¿å­˜è¯·ä½¿ç”¨ç¼–è¾‘å™¨çš„"æ–‡ä»¶ â†’ ç«‹å³ä¿å­˜"åŠŸèƒ½');
            log(output, '=' .repeat(60));
        }

        async function checkMyProjects() {
            const output = 'projects-output';
            log(output, '=' .repeat(60), true);
            log(output, 'ğŸ“‹ è·å–æˆ‘çš„é¡¹ç›®åˆ—è¡¨');
            log(output, '=' .repeat(60));

            try {
                const response = await fetch(`${API_BASE}/scratch/mystuff/`, {
                    credentials: 'include'
                });

                if (!response.ok) {
                    log(output, `<span class="status error">ERROR</span> API è¿”å›é”™è¯¯: ${response.status}`);
                    return;
                }

                const data = await response.json();
                log(output, `<span class="status success">OK</span> æˆåŠŸè·å–é¡¹ç›®åˆ—è¡¨`);
                log(output, `ğŸ“Š æ€»é¡¹ç›®æ•°: ${data.results.length}`);
                log(output, '');

                data.results.slice(0, 5).forEach((project, index) => {
                    const blocks = project.data_json && project.data_json.targets
                        ? project.data_json.targets.reduce((sum, t) => 
                            sum + Object.keys(t.blocks || {}).length, 0)
                        : 0;

                    log(output, `${index + 1}. ID ${project.id}: ${project.title}`);
                    log(output, `   ğŸ“Š ç§¯æœ¨æ•°é‡: ${blocks}`);
                    log(output, `   ğŸ•’ æ›´æ–°æ—¶é—´: ${new Date(project.updated_at).toLocaleString()}`);
                    log(output, '');
                });

                log(output, '=' .repeat(60));
            } catch (error) {
                log(output, `<span class="status error">ERROR</span> è¯·æ±‚å¤±è´¥: ${error.message}`);
                log(output, 'ğŸ’¡ ç¡®ä¿å·²ç™»å½•');
            }
        }

        async function runFullDiagnosis() {
            const output = 'full-output';
            log(output, 'ğŸš€ å¼€å§‹å®Œæ•´è¯Šæ–­...', true);
            log(output, '');

            // 1. æ£€æŸ¥ VM
            log(output, 'ã€æ­¥éª¤ 1/4ã€‘æ£€æŸ¥ VM çŠ¶æ€');
            const vmStatus = await checkVMStatus();
            await sleep(500);

            // 2. å¯¼å‡ºæ•°æ®
            log(output, '');
            log(output, 'ã€æ­¥éª¤ 2/4ã€‘å¯¼å‡ºé¡¹ç›®æ•°æ®');
            const projectData = await exportProjectData();
            await sleep(500);

            // 3. æ£€æŸ¥é¡¹ç›®åˆ—è¡¨
            log(output, '');
            log(output, 'ã€æ­¥éª¤ 3/4ã€‘æ£€æŸ¥é¡¹ç›®åˆ—è¡¨');
            await checkMyProjects();
            await sleep(500);

            // 4. æ€»ç»“
            log(output, '');
            log(output, '=' .repeat(60));
            log(output, 'ğŸ“Š è¯Šæ–­æ€»ç»“');
            log(output, '=' .repeat(60));

            if (vmStatus && vmStatus.totalBlocks > 0) {
                log(output, '<span class="status success">âœ…</span> VM çŠ¶æ€æ­£å¸¸ï¼ŒåŒ…å«ç§¯æœ¨');
            } else if (vmStatus && vmStatus.totalBlocks === 0) {
                log(output, '<span class="status warning">âš ï¸</span> VM ä¸­æ²¡æœ‰ç§¯æœ¨');
                log(output, '   å»ºè®®ï¼šåœ¨ç¼–è¾‘å™¨ä¸­æ·»åŠ ä¸€äº›ç§¯æœ¨å†è¿›è¡Œæµ‹è¯•');
            } else {
                log(output, '<span class="status error">âŒ</span> æ— æ³•è®¿é—® VM');
                log(output, '   å¯èƒ½åŸå› ï¼šè·¨åŸŸé™åˆ¶æˆ– iframe æœªåŠ è½½');
            }

            if (projectData) {
                const blocks = projectData.targets.reduce((sum, t) => 
                    sum + Object.keys(t.blocks || {}).length, 0);
                if (blocks > 0) {
                    log(output, '<span class="status success">âœ…</span> æ•°æ®å¯¼å‡ºæ­£å¸¸');
                } else {
                    log(output, '<span class="status error">âŒ</span> å¯¼å‡ºçš„æ•°æ®ä¸­æ²¡æœ‰ç§¯æœ¨');
                }
            }

            log(output, '=' .repeat(60));
            log(output, 'âœ… è¯Šæ–­å®Œæˆï¼');
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
    </script>
</body>
</html>

