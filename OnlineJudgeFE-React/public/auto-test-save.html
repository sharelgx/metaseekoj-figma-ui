<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Scratch ä¿å­˜åŠŸèƒ½è‡ªåŠ¨åŒ–æµ‹è¯•</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            padding: 20px;
            background: #000;
            color: #0f0;
            margin: 0;
        }
        .container {
            max-width: 1600px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 500px 1fr;
            gap: 20px;
            height: 100vh;
        }
        .left-panel {
            overflow-y: auto;
        }
        h1 {
            color: #0ff;
            font-size: 20px;
            margin: 0 0 20px 0;
        }
        .controls {
            background: #1a1a1a;
            border: 2px solid #0a0;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
        }
        button {
            background: #0a0;
            color: #000;
            border: none;
            padding: 12px 20px;
            margin: 5px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 14px;
            font-weight: bold;
            width: calc(100% - 10px);
        }
        button:hover {
            background: #0f0;
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        #logs {
            background: #0a0a0a;
            border: 2px solid #0a0;
            padding: 15px;
            height: calc(100vh - 400px);
            overflow-y: auto;
            font-size: 12px;
            line-height: 1.6;
            border-radius: 8px;
        }
        .log-entry {
            margin: 3px 0;
            padding: 5px 8px;
            border-left: 3px solid #0a0;
        }
        .log-success { color: #0f0; border-left-color: #0f0; font-weight: bold; }
        .log-error { color: #f00; border-left-color: #f00; }
        .log-warning { color: #ff0; border-left-color: #ff0; }
        .log-info { color: #0ff; border-left-color: #0ff; }
        .status {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 11px;
            margin-left: 10px;
        }
        .status.pending { background: #666; }
        .status.running { background: #00f; }
        .status.passed { background: #0a0; color: #000; }
        .status.failed { background: #f00; color: #fff; }
        iframe {
            width: 100%;
            height: 100%;
            border: 2px solid #0a0;
            border-radius: 8px;
        }
        .test-item {
            background: #0a0a0a;
            padding: 8px 12px;
            margin: 5px 0;
            border-left: 4px solid #666;
        }
        .test-item.passed { border-left-color: #0f0; }
        .test-item.failed { border-left-color: #f00; }
        .test-item.running { border-left-color: #00f; }
    </style>
</head>
<body>
    <div class="container">
        <div class="left-panel">
            <h1>ğŸ¤– Scratch ä¿å­˜åŠŸèƒ½è‡ªåŠ¨åŒ–æµ‹è¯•</h1>
            
            <div class="controls">
                <h2 style="color: #0ff; font-size: 16px; margin: 0 0 10px 0;">æµ‹è¯•æ§åˆ¶</h2>
                <button id="startBtn" onclick="runAllTests()">ğŸš€ å¼€å§‹è‡ªåŠ¨æµ‹è¯•</button>
                <button onclick="clearLogs()">ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—</button>
                <button onclick="location.reload()">ğŸ”„ é‡æ–°å¼€å§‹</button>
            </div>

            <div class="controls">
                <h2 style="color: #0ff; font-size: 16px; margin: 0 0 10px 0;">æµ‹è¯•é¡¹ç›®</h2>
                <div id="tests"></div>
            </div>

            <div id="logs"></div>
        </div>

        <div>
            <h1 style="margin-bottom: 10px;">ğŸ“º Scratch ç¼–è¾‘å™¨</h1>
            <iframe id="iframe" src="http://localhost:8601/"></iframe>
        </div>
    </div>

    <script>
        const logsDiv = document.getElementById('logs');
        const testsDiv = document.getElementById('tests');
        const startBtn = document.getElementById('startBtn');
        
        let iframe = null;
        let vmReady = false;
        let testResults = {
            passed: 0,
            failed: 0,
            total: 0
        };

        const tests = [
            { name: 'iframe åŠ è½½', status: 'pending' },
            { name: 'VM åˆå§‹åŒ–', status: 'pending' },
            { name: 'å¯¼å‡ºå‡½æ•°æ£€æµ‹', status: 'pending' },
            { name: 'å¯¼å‡ºé¡¹ç›®æ•°æ®', status: 'pending' },
            { name: 'æ•°æ®å®Œæ•´æ€§éªŒè¯', status: 'pending' }
        ];

        function updateTestList() {
            testsDiv.innerHTML = tests.map((test, i) => `
                <div class="test-item ${test.status}">
                    ${i + 1}. ${test.name}
                    <span class="status ${test.status}">${
                        test.status === 'pending' ? 'ç­‰å¾…' :
                        test.status === 'running' ? 'è¿è¡Œä¸­' :
                        test.status === 'passed' ? 'âœ… é€šè¿‡' :
                        'âŒ å¤±è´¥'
                    }</span>
                </div>
            `).join('');
        }

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${timestamp}] ${message}`;
            logsDiv.appendChild(entry);
            logsDiv.scrollTop = logsDiv.scrollHeight;
            console.log(`[${type}] ${message}`);
        }

        function clearLogs() {
            logsDiv.innerHTML = '';
        }

        function updateTest(index, status) {
            tests[index].status = status;
            updateTestList();
            
            if (status === 'passed') {
                testResults.passed++;
            } else if (status === 'failed') {
                testResults.failed++;
            }
        }

        async function runAllTests() {
            startBtn.disabled = true;
            clearLogs();
            
            testResults = { passed: 0, failed: 0, total: tests.length };
            tests.forEach(t => t.status = 'pending');
            updateTestList();
            
            log('ğŸš€ å¼€å§‹è‡ªåŠ¨åŒ–æµ‹è¯•...', 'success');
            log('', 'info');
            
            // æµ‹è¯• 1: iframe åŠ è½½
            updateTest(0, 'running');
            await sleep(1000);
            
            iframe = document.getElementById('iframe');
            if (iframe && iframe.contentWindow) {
                log('âœ… æµ‹è¯• 1: iframe åŠ è½½æˆåŠŸ', 'success');
                updateTest(0, 'passed');
            } else {
                log('âŒ æµ‹è¯• 1: iframe åŠ è½½å¤±è´¥', 'error');
                updateTest(0, 'failed');
                showSummary();
                return;
            }
            
            // æµ‹è¯• 2: ç­‰å¾… VM åˆå§‹åŒ–
            updateTest(1, 'running');
            log('â³ ç­‰å¾… VM åˆå§‹åŒ–ï¼ˆæœ€å¤š 10 ç§’ï¼‰...', 'info');
            
            const vmReadyPromise = new Promise((resolve, reject) => {
                const timeout = setTimeout(() => reject('VM åˆå§‹åŒ–è¶…æ—¶'), 10000);
                const handler = (event) => {
                    if (event.data && event.data.type === 'SCRATCH_VM_READY') {
                        clearTimeout(timeout);
                        window.removeEventListener('message', handler);
                        resolve();
                    }
                };
                window.addEventListener('message', handler);
            });
            
            try {
                await vmReadyPromise;
                vmReady = true;
                log('âœ… æµ‹è¯• 2: VM åˆå§‹åŒ–æˆåŠŸ', 'success');
                updateTest(1, 'passed');
            } catch (e) {
                log('âŒ æµ‹è¯• 2: VM åˆå§‹åŒ–å¤±è´¥ - ' + e, 'error');
                updateTest(1, 'failed');
                showSummary();
                return;
            }
            
            // æµ‹è¯• 3: æ£€æµ‹å¯¼å‡ºå‡½æ•°
            updateTest(2, 'running');
            await sleep(1000);
            
            log('ğŸ“¨ å‘é€å¯¼å‡ºè¯·æ±‚æµ‹è¯•...', 'info');
            const exportTestPromise = new Promise((resolve, reject) => {
                const timeout = setTimeout(() => reject('å¯¼å‡ºè¯·æ±‚æ— å“åº”'), 5000);
                const handler = (event) => {
                    if (event.data && event.data.type === 'EXPORT_PROJECT_RESPONSE') {
                        clearTimeout(timeout);
                        window.removeEventListener('message', handler);
                        resolve(event.data.data);
                    }
                };
                window.addEventListener('message', handler);
                
                iframe.contentWindow.postMessage({
                    type: 'EXPORT_PROJECT_REQUEST'
                }, '*');
            });
            
            try {
                const data = await exportTestPromise;
                log('âœ… æµ‹è¯• 3: å¯¼å‡ºå‡½æ•°å“åº”æ­£å¸¸', 'success');
                updateTest(2, 'passed');
                
                // æµ‹è¯• 4: å¯¼å‡ºé¡¹ç›®æ•°æ®
                updateTest(3, 'running');
                
                if (data) {
                    const dataSize = JSON.stringify(data).length;
                    log('âœ… æµ‹è¯• 4: æˆåŠŸå¯¼å‡ºé¡¹ç›®æ•°æ®', 'success');
                    log(`   æ•°æ®å¤§å°: ${dataSize} å­—èŠ‚`, 'info');
                    updateTest(3, 'passed');
                    
                    // æµ‹è¯• 5: æ•°æ®å®Œæ•´æ€§
                    updateTest(4, 'running');
                    
                    if (data.targets && data.meta) {
                        log('âœ… æµ‹è¯• 5: æ•°æ®å®Œæ•´æ€§éªŒè¯é€šè¿‡', 'success');
                        log(`   åŒ…å« ${data.targets.length} ä¸ªå¯¹è±¡`, 'info');
                        log(`   meta.semver: ${data.meta.semver}`, 'info');
                        updateTest(4, 'passed');
                    } else {
                        log('âŒ æµ‹è¯• 5: æ•°æ®ç¼ºå°‘å¿…è¦å­—æ®µ', 'error');
                        updateTest(4, 'failed');
                    }
                } else {
                    log('âŒ æµ‹è¯• 4: å¯¼å‡ºçš„æ•°æ®ä¸ºç©º', 'error');
                    updateTest(3, 'failed');
                    updateTest(4, 'failed');
                }
            } catch (e) {
                log('âŒ æµ‹è¯• 3: å¯¼å‡ºå‡½æ•°æµ‹è¯•å¤±è´¥ - ' + e, 'error');
                updateTest(2, 'failed');
                updateTest(3, 'failed');
                updateTest(4, 'failed');
            }
            
            showSummary();
        }

        function showSummary() {
            log('', 'info');
            log('========== æµ‹è¯•æ€»ç»“ ==========', 'info');
            log(`é€šè¿‡: ${testResults.passed} / ${testResults.total}`, testResults.passed === testResults.total ? 'success' : 'warning');
            log(`å¤±è´¥: ${testResults.failed} / ${testResults.total}`, testResults.failed > 0 ? 'error' : 'info');
            
            if (testResults.failed === 0) {
                log('', 'info');
                log('ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼ä¿å­˜åŠŸèƒ½æ­£å¸¸ï¼', 'success');
                log('', 'info');
                log('ğŸ’¡ ç°åœ¨å¯ä»¥åœ¨ç¼–è¾‘å™¨ä¸­æµ‹è¯•ä¿å­˜åŠŸèƒ½äº†', 'info');
            } else {
                log('', 'info');
                log('âŒ æœ‰æµ‹è¯•å¤±è´¥ï¼Œè¯·æ£€æŸ¥é”™è¯¯æ—¥å¿—', 'error');
            }
            
            startBtn.disabled = false;
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // ç›‘å¬æ‰€æœ‰æ¶ˆæ¯ï¼ˆç”¨äºè°ƒè¯•ï¼‰
        window.addEventListener('message', (event) => {
            if (!event.origin.includes('localhost')) return;
            
            if (event.data && event.data.type === 'SCRATCH_VM_READY') {
                vmReady = true;
            }
        });

        // é¡µé¢åŠ è½½å®Œæˆ
        window.addEventListener('load', () => {
            log('ğŸš€ è‡ªåŠ¨åŒ–æµ‹è¯•å·¥å…·å·²å¯åŠ¨', 'success');
            log('ğŸ’¡ ç‚¹å‡»"å¼€å§‹è‡ªåŠ¨æµ‹è¯•"æŒ‰é’®å¼€å§‹', 'info');
            log('', 'info');
            updateTestList();
        });

        // iframe åŠ è½½å®Œæˆ
        document.getElementById('iframe').addEventListener('load', () => {
            log('âœ… Scratch ç¼–è¾‘å™¨ iframe å·²åŠ è½½', 'success');
        });
    </script>
</body>
</html>

