<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>çœŸå®æµè§ˆå™¨æµ‹è¯•</title>
    <style>
        body {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            padding: 30px;
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            color: #e2e8f0;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
        }
        
        h1 {
            font-size: 32px;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .subtitle {
            color: #94a3b8;
            margin-bottom: 30px;
            font-size: 14px;
        }
        
        .grid {
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .panel {
            background: #334155;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        
        h2 {
            font-size: 18px;
            margin-bottom: 20px;
            color: #f1f5f9;
            border-bottom: 2px solid #475569;
            padding-bottom: 10px;
        }
        
        .test-item {
            margin-bottom: 15px;
            padding: 15px;
            background: #1e293b;
            border-radius: 8px;
            border-left: 4px solid #64748b;
        }
        
        .test-item.running { border-left-color: #f59e0b; background: #422006; }
        .test-item.success { border-left-color: #10b981; background: #022c22; }
        .test-item.error { border-left-color: #ef4444; background: #2c0b0e; }
        
        .test-name {
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 15px;
        }
        
        .test-result {
            font-size: 13px;
            color: #cbd5e1;
            line-height: 1.6;
        }
        
        button {
            padding: 12px 24px;
            margin: 5px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .btn-success {
            background: #10b981;
            color: white;
        }
        
        .btn-success:hover {
            background: #059669;
        }
        
        iframe {
            width: 100%;
            height: 800px;
            border: none;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.4);
        }
        
        .log-console {
            background: #0f172a;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 15px;
        }
        
        .log-entry {
            padding: 4px 0;
            border-bottom: 1px solid #1e293b;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat {
            background: #1e293b;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 12px;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª Scratch ç¼–è¾‘å™¨çœŸå®æµè§ˆå™¨æµ‹è¯•</h1>
        <p class="subtitle">ç›´æ¥åœ¨æµè§ˆå™¨ä¸­æ£€æµ‹ iframe å’Œç”¨æˆ·çŠ¶æ€</p>
        
        <div class="stats">
            <div class="stat">
                <div class="stat-value" id="test-count">0</div>
                <div class="stat-label">å·²å®Œæˆæµ‹è¯•</div>
            </div>
            <div class="stat">
                <div class="stat-value" style="color: #10b981;" id="pass-count">0</div>
                <div class="stat-label">é€šè¿‡</div>
            </div>
            <div class="stat-value" style="color: #ef4444;" id="fail-count">0</div>
                <div class="stat-label">å¤±è´¥</div>
            </div>
        </div>
        
        <div class="grid">
            <div>
                <div class="panel">
                    <h2>ğŸ® æµ‹è¯•æ§åˆ¶</h2>
                    <button class="btn-primary" onclick="runAllTests()">ğŸš€ è¿è¡Œå®Œæ•´æµ‹è¯•</button>
                    <button class="btn-success" onclick="openEditor()">ğŸ“ æ‰“å¼€ç¼–è¾‘å™¨ï¼ˆæ–°æ ‡ç­¾ï¼‰</button>
                    
                    <h2 style="margin-top: 30px;">ğŸ“‹ æµ‹è¯•ç»“æœ</h2>
                    <div id="test-results"></div>
                </div>
            </div>
            
            <div>
                <div class="panel">
                    <h2>ğŸ–¥ï¸ ç¼–è¾‘å™¨é¢„è§ˆï¼ˆiframeï¼‰</h2>
                    <iframe id="editor-frame" src="http://localhost:8081/classroom/scratch/editor/7"></iframe>
                    
                    <div class="log-console">
                        <div style="color: #94a3b8; margin-bottom: 10px;">ğŸ“œ æ§åˆ¶å°æ—¥å¿—ï¼ˆå®æ—¶ï¼‰</div>
                        <div id="console-log"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let testCount = 0;
        let passCount = 0;
        let failCount = 0;
        
        function updateStats() {
            document.getElementById('test-count').textContent = testCount;
            document.getElementById('pass-count').textContent = passCount;
            document.getElementById('fail-count').textContent = failCount;
        }
        
        function logTest(name, result, details = '') {
            testCount++;
            if (result) passCount++;
            else failCount++;
            updateStats();
            
            const div = document.createElement('div');
            div.className = `test-item ${result ? 'success' : 'error'}`;
            div.innerHTML = `
                <div class="test-name">${result ? 'âœ…' : 'âŒ'} ${name}</div>
                <div class="test-result">${details}</div>
            `;
            document.getElementById('test-results').insertBefore(div, document.getElementById('test-results').firstChild);
        }
        
        function logConsole(msg) {
            const div = document.createElement('div');
            div.className = 'log-entry';
            div.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            const console = document.getElementById('console-log');
            console.insertBefore(div, console.firstChild);
            
            if (console.children.length > 50) {
                console.removeChild(console.lastChild);
            }
        }
        
        async function runAllTests() {
            document.getElementById('test-results').innerHTML = '';
            testCount = 0;
            passCount = 0;
            failCount = 0;
            updateStats();
            
            logConsole('ğŸš€ å¼€å§‹æµ‹è¯•...');
            
            // æµ‹è¯•1: æ£€æŸ¥ç™»å½•çŠ¶æ€
            try {
                const res = await fetch('http://localhost:8086/api/profile/', {credentials: 'include'});
                const data = await res.json();
                
                if (data.error === null && data.data) {
                    const username = data.data.real_name || data.data.user?.username;
                    logTest('æ£€æŸ¥ç™»å½•çŠ¶æ€', true, `ç”¨æˆ·: ${username}`);
                    logConsole(`âœ… ç”¨æˆ·å·²ç™»å½•: ${username}`);
                } else {
                    logTest('æ£€æŸ¥ç™»å½•çŠ¶æ€', false, 'ç”¨æˆ·æœªç™»å½•');
                    logConsole('âŒ ç”¨æˆ·æœªç™»å½•');
                }
            } catch (e) {
                logTest('æ£€æŸ¥ç™»å½•çŠ¶æ€', false, e.message);
                logConsole(`âŒ ç™»å½•æ£€æŸ¥å¤±è´¥: ${e.message}`);
            }
            
            // æµ‹è¯•2: æ£€æŸ¥é¡¹ç›®7æ•°æ®
            try {
                const res = await fetch('http://localhost:8086/api/scratch/projects/7/', {credentials: 'include'});
                const project = await res.json();
                
                const hasData = project.data_json && typeof project.data_json === 'object';
                const hasTargets = hasData && project.data_json.targets;
                const hasThumbnail = project.cover_url && project.cover_url.length > 0;
                
                logTest('æ£€æŸ¥é¡¹ç›®7æ•°æ®', hasData && hasTargets, 
                    `data_json: ${hasData ? 'å¯¹è±¡âœ“' : 'é”™è¯¯âœ—'}, targets: ${hasTargets ? 'å­˜åœ¨âœ“' : 'ä¸å­˜åœ¨âœ—'}`);
                    
                logTest('æ£€æŸ¥é¡¹ç›®7ç¼©ç•¥å›¾', hasThumbnail,
                    `cover_urlé•¿åº¦: ${project.cover_url ? project.cover_url.length : 0} å­—èŠ‚`);
                    
                logConsole(`é¡¹ç›®7 - data_jsonç±»å‹: ${typeof project.data_json}`);
                logConsole(`é¡¹ç›®7 - æœ‰targets: ${hasTargets ? 'æ˜¯' : 'å¦'}`);
                logConsole(`é¡¹ç›®7 - ç¼©ç•¥å›¾: ${hasThumbnail ? 'æœ‰' : 'æ— '}`);
            } catch (e) {
                logTest('æ£€æŸ¥é¡¹ç›®7', false, e.message);
                logConsole(`âŒ é¡¹ç›®7æ£€æŸ¥å¤±è´¥: ${e.message}`);
            }
            
            // æµ‹è¯•3: æ£€æŸ¥ iframe åŠ è½½
            await new Promise(resolve => setTimeout(resolve, 3000));
            
            try {
                const iframe = document.getElementById('editor-frame');
                if (iframe && iframe.contentWindow) {
                    logTest('iframe åŠ è½½', true, 'iframe å­˜åœ¨ä¸”å¯è®¿é—®');
                    logConsole('âœ… iframe å·²åŠ è½½');
                    
                    // å°è¯•å‘ iframe å‘é€æ¶ˆæ¯
                    const userRes = await fetch('http://localhost:8086/api/profile/', {credentials: 'include'});
                    const userData = await userRes.json();
                    
                    if (userData.error === null && userData.data) {
                        const username = userData.data.real_name || userData.data.user?.username;
                        const avatar = userData.data.avatar;
                        
                        iframe.contentWindow.postMessage({
                            type: 'USER_INFO_UPDATE',
                            data: {
                                isLoggedIn: true,
                                username: username,
                                avatarUrl: avatar ? 'http://localhost:8086' + avatar : null
                            }
                        }, '*');
                        
                        logTest('å‘ iframe å‘é€ç”¨æˆ·ä¿¡æ¯', true, `å·²å‘é€: ${username}`);
                        logConsole(`ğŸ“¨ å·²å‘ iframe å‘é€ç”¨æˆ·ä¿¡æ¯: ${username}`);
                        logConsole('â° ç­‰å¾… 2 ç§’åæ£€æŸ¥ iframe æ˜¯å¦æ˜¾ç¤ºç”¨æˆ·å...');
                        
                        // ç­‰å¾… 2 ç§’åæç¤ºç”¨æˆ·æ£€æŸ¥
                        setTimeout(() => {
                            logConsole('');
                            logConsole('ğŸ” è¯·æŸ¥çœ‹ä¸Šæ–¹ iframeï¼Œå³ä¸Šè§’æ˜¯å¦æ˜¾ç¤º"æŸ³è€å¸ˆ"ï¼Ÿ');
                            logConsole('');
                            logConsole('å¦‚æœæ˜¾ç¤º"ç™»å½•"æŒ‰é’®è€Œä¸æ˜¯"æŸ³è€å¸ˆ"ï¼š');
                            logConsole('  1. è¯´æ˜ postMessage æœªè¢« iframe æ¥æ”¶');
                            logConsole('  2. æˆ–è€… iframe å†…éƒ¨çš„æ¸²æŸ“é€»è¾‘æœ‰é—®é¢˜');
                            logConsole('');
                            logConsole('ğŸ“ è¯·åœ¨ iframe ä¸Šå³é”® â†’ æ£€æŸ¥ï¼ŒæŸ¥çœ‹ iframe çš„æ§åˆ¶å°æ—¥å¿—');
                        }, 2000);
                    }
                } else {
                    logTest('iframe åŠ è½½', false, 'iframe ä¸å­˜åœ¨æˆ–æ— æ³•è®¿é—®');
                    logConsole('âŒ iframe æœªæ‰¾åˆ°');
                }
            } catch (e) {
                logTest('iframe æ£€æŸ¥', false, e.message);
                logConsole(`âŒ iframeæ£€æŸ¥å¤±è´¥: ${e.message}`);
            }
            
            logConsole('');
            logConsole('='.repeat(50));
            logConsole('âœ… è‡ªåŠ¨åŒ–æµ‹è¯•å®Œæˆï¼');
            logConsole('');
            logConsole('ğŸ‘€ ç°åœ¨è¯·ç”¨çœ¼ç›æŸ¥çœ‹ä¸Šæ–¹çš„ iframeï¼š');
            logConsole('  1. å³ä¸Šè§’æ˜¯å¦æ˜¾ç¤º"æŸ³è€å¸ˆ"ï¼Ÿ');
            logConsole('  2. æ˜¯å¦åŠ è½½äº†é¡¹ç›®å†…å®¹ï¼ˆç§¯æœ¨å—ã€è§’è‰²ï¼‰ï¼Ÿ');
            logConsole('  3. å¦‚æœéƒ½æ²¡æœ‰ï¼Œè¯·åœ¨ iframe ä¸Šå³é”® â†’ æ£€æŸ¥å…ƒç´ ');
            logConsole('  4. åˆ‡æ¢åˆ° Console æ ‡ç­¾ï¼ŒæŸ¥çœ‹ iframe å†…éƒ¨çš„æ—¥å¿—');
            logConsole('='.repeat(50));
        }
        
        function openEditor() {
            window.open('http://localhost:8081/classroom/scratch/editor/7', '_blank');
        }
        
        // ç›‘å¬æ¥è‡ª iframe çš„æ¶ˆæ¯
        window.addEventListener('message', (event) => {
            if (event.origin.includes('localhost')) {
                logConsole(`ğŸ“¬ æ”¶åˆ° iframe æ¶ˆæ¯: ${event.data.type || JSON.stringify(event.data)}`);
                
                if (event.data.type === 'USER_INFO_UPDATE_ACK') {
                    logConsole(`âœ… iframe å·²ç¡®è®¤æ”¶åˆ°ç”¨æˆ·ä¿¡æ¯`);
                }
            }
        });
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡Œæµ‹è¯•
        window.addEventListener('load', () => {
            logConsole('ğŸ“Œ é¡µé¢å·²åŠ è½½ï¼Œç­‰å¾… iframe å®Œå…¨åŠ è½½...');
            
            // ç­‰å¾… iframe åŠ è½½
            const iframe = document.getElementById('editor-frame');
            iframe.addEventListener('load', () => {
                logConsole('âœ… iframe å·²åŠ è½½å®Œæˆ');
                logConsole('ğŸ”„ 3ç§’åè‡ªåŠ¨å¼€å§‹æµ‹è¯•...');
                
                setTimeout(() => {
                    runAllTests();
                }, 3000);
            });
        });
    </script>
</body>
</html>

