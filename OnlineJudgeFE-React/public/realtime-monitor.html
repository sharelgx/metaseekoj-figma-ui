<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>å®æ—¶ç›‘æ§</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #000; color: #0f0; margin: 0; }
        .container { max-width: 1800px; margin: 0 auto; display: grid; grid-template-columns: 600px 1fr; gap: 20px; height: 100vh; }
        .left { overflow-y: auto; }
        h1 { color: #0ff; font-size: 18px; margin: 0 0 15px 0; }
        .panel { background: #0a0a0a; border: 2px solid #0a0; padding: 15px; margin-bottom: 15px; border-radius: 8px; }
        .status-item { padding: 8px; margin: 5px 0; border-left: 4px solid #666; background: #111; }
        .ok { border-left-color: #0f0; color: #0f0; }
        .error { border-left-color: #f00; color: #f00; }
        .warning { border-left-color: #ff0; color: #ff0; }
        #logs { height: 400px; overflow-y: auto; font-size: 12px; }
        .log { padding: 5px; margin: 2px 0; border-left: 3px solid #0a0; }
        iframe { width: 100%; height: 100%; border: 2px solid #0a0; }
        button { background: #0a0; color: #000; border: none; padding: 10px 20px; margin: 5px; cursor: pointer; border-radius: 4px; font-weight: bold; width: calc(100% - 10px); }
        button:hover { background: #0f0; }
    </style>
</head>
<body>
    <div class="container">
        <div class="left">
            <h1>ğŸ”¬ Scratch ç¼–è¾‘å™¨å®æ—¶ç›‘æ§</h1>
            
            <div class="panel">
                <h2 style="color: #0ff; font-size: 16px; margin: 0 0 10px 0;">å®æ—¶çŠ¶æ€</h2>
                <div id="status">
                    <div class="status-item warning">â³ ç­‰å¾… iframe åŠ è½½...</div>
                </div>
            </div>

            <div class="panel">
                <h2 style="color: #0ff; font-size: 16px; margin: 0 0 10px 0;">æ”¶åˆ°çš„æ¶ˆæ¯</h2>
                <div id="messages" style="max-height: 200px; overflow-y: auto; font-size: 11px;">
                    <div class="status-item">ç­‰å¾…æ¶ˆæ¯...</div>
                </div>
            </div>

            <div class="panel">
                <h2 style="color: #0ff; font-size: 16px; margin: 0 0 10px 0;">æ—¥å¿—</h2>
                <div id="logs"></div>
            </div>
        </div>

        <div>
            <h1 style="margin-bottom: 10px;">ğŸ“º Scratch ç¼–è¾‘å™¨ï¼ˆç‹¬ç«‹ï¼‰</h1>
            <p style="color: #888; font-size: 12px;">ç›´æ¥åŠ è½½ 8601 ç«¯å£ï¼Œé¿å…åµŒå¥— iframe</p>
            <iframe id="iframe" src="http://localhost:8601/"></iframe>
        </div>
    </div>

    <script>
        const statusDiv = document.getElementById('status');
        const messagesDiv = document.getElementById('messages');
        const logsDiv = document.getElementById('logs');
        
        let messageCount = 0;
        let vmReady = false;
        let currentStatus = {};

        function log(msg, type = 'info') {
            const div = document.createElement('div');
            div.className = 'log';
            div.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            logsDiv.appendChild(div);
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }

        function updateStatus(data) {
            currentStatus = data;
            
            let html = '';
            
            if (data.vmReady !== undefined) {
                html += `<div class="status-item ${data.vmReady ? 'ok' : 'error'}">
                    VM åˆå§‹åŒ–: ${data.vmReady ? 'âœ… æ˜¯' : 'âŒ å¦'}
                </div>`;
            }
            
            if (data.exportFn !== undefined) {
                html += `<div class="status-item ${data.exportFn ? 'ok' : 'error'}">
                    å¯¼å‡ºå‡½æ•°: ${data.exportFn ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨'}
                </div>`;
            }
            
            if (data.loadFn !== undefined) {
                html += `<div class="status-item ${data.loadFn ? 'ok' : 'error'}">
                    åŠ è½½å‡½æ•°: ${data.loadFn ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨'}
                </div>`;
            }
            
            if (data.userLoggedIn !== undefined) {
                html += `<div class="status-item ${data.userLoggedIn ? 'ok' : 'warning'}">
                    ç™»å½•çŠ¶æ€: ${data.userLoggedIn ? 'âœ… å·²ç™»å½•' : 'âš ï¸ æœªç™»å½•'}
                </div>`;
            }
            
            const allReady = data.vmReady && data.exportFn && data.loadFn;
            html += `<div class="status-item ${allReady ? 'ok' : 'error'}" style="margin-top: 10px; font-size: 14px; font-weight: bold;">
                ğŸ’¾ ä¿å­˜åŠŸèƒ½: ${allReady ? 'âœ… å·²å°±ç»ª' : 'âŒ æœªå°±ç»ª'}
            </div>`;
            
            statusDiv.innerHTML = html || '<div class="status-item warning">â³ ç­‰å¾…æ•°æ®...</div>';
        }

        // ç›‘å¬æ‰€æœ‰æ¶ˆæ¯
        window.addEventListener('message', (event) => {
            if (!event.origin.includes('localhost')) return;
            
            messageCount++;
            
            const msgDiv = document.createElement('div');
            msgDiv.className = 'status-item';
            msgDiv.textContent = `#${messageCount} [${new Date().toLocaleTimeString()}] ${event.data.type || 'unknown'}`;
            messagesDiv.appendChild(msgDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            
            if (messagesDiv.children.length > 20) {
                messagesDiv.removeChild(messagesDiv.children[0]);
            }
            
            // å¤„ç†ç‰¹å®šæ¶ˆæ¯
            if (event.data.type === 'SCRATCH_VM_READY') {
                vmReady = true;
                log('ğŸ‰ æ”¶åˆ° SCRATCH_VM_READY æ¶ˆæ¯ï¼', 'ok');
                checkStatus();
            }
            
            if (event.data.type === 'STATUS_RESPONSE') {
                log('âœ… æ”¶åˆ°çŠ¶æ€å“åº”', 'ok');
                updateStatus(event.data.data);
            }
            
            if (event.data.type === 'USER_INFO_UPDATE_ACK') {
                log('âœ… ç”¨æˆ·ä¿¡æ¯å·²åŒæ­¥', 'ok');
            }
        });

        function checkStatus() {
            const iframe = document.getElementById('iframe');
            if (!iframe || !iframe.contentWindow) {
                log('âŒ iframe æœªå‡†å¤‡å¥½', 'error');
                return;
            }
            
            log('ğŸ“¨ å‘é€çŠ¶æ€æ£€æŸ¥è¯·æ±‚...', 'info');
            iframe.contentWindow.postMessage({ type: 'CHECK_STATUS' }, '*');
        }

        // é¡µé¢åŠ è½½å®Œæˆ
        window.addEventListener('load', () => {
            log('ğŸš€ ç›‘æ§å·¥å…·å·²å¯åŠ¨', 'ok');
            log('â³ ç­‰å¾… iframe åŠ è½½...', 'info');
            
            // æ¯3ç§’è‡ªåŠ¨æ£€æŸ¥ä¸€æ¬¡çŠ¶æ€
            setInterval(() => {
                if (vmReady || messageCount > 5) {
                    checkStatus();
                }
            }, 3000);
        });

        // iframe åŠ è½½å®Œæˆ
        document.getElementById('iframe').addEventListener('load', () => {
            log('âœ… iframe å†…å®¹å·²åŠ è½½', 'ok');
            
            setTimeout(() => {
                log('â° 5ç§’åé¦–æ¬¡æ£€æŸ¥çŠ¶æ€...', 'info');
                checkStatus();
            }, 5000);
        });
    </script>
</body>
</html>

