<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scratch ç¼–è¾‘å™¨ç«¯åˆ°ç«¯æµ‹è¯•</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: 20px;
        }
        
        .panel {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            margin-bottom: 20px;
            font-size: 24px;
        }
        
        h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 18px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        
        .test-step {
            margin-bottom: 15px;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #e5e7eb;
        }
        
        .test-step.pending {
            background: #f3f4f6;
            border-color: #d1d5db;
        }
        
        .test-step.running {
            background: #fef3c7;
            border-color: #fbbf24;
        }
        
        .test-step.success {
            background: #d1fae5;
            border-color: #10b981;
        }
        
        .test-step.error {
            background: #fee2e2;
            border-color: #ef4444;
        }
        
        .step-title {
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 16px;
        }
        
        .step-detail {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }
        
        .buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        button {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5568d3;
        }
        
        .btn-success {
            background: #10b981;
            color: white;
        }
        
        .btn-success:hover {
            background: #059669;
        }
        
        .btn-danger {
            background: #ef4444;
            color: white;
        }
        
        .btn-danger:hover {
            background: #dc2626;
        }
        
        .log {
            background: #1e293b;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 600px;
            overflow-y: auto;
            line-height: 1.6;
        }
        
        .log-entry {
            margin-bottom: 4px;
            padding: 4px 8px;
            border-left: 3px solid #667eea;
            padding-left: 12px;
        }
        
        .log-success { border-left-color: #10b981; color: #86efac; }
        .log-error { border-left-color: #ef4444; color: #fca5a5; }
        .log-warning { border-left-color: #f59e0b; color: #fcd34d; }
        .log-info { border-left-color: #3b82f6; color: #93c5fd; }
        
        .timestamp {
            color: #94a3b8;
            margin-right: 8px;
        }
        
        iframe {
            width: 100%;
            height: 700px;
            border: none;
            border-radius: 8px;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .stat-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 12px;
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å·¦ä¾§æ§åˆ¶é¢æ¿ -->
        <div>
            <div class="panel">
                <h1>ğŸ§ª ç«¯åˆ°ç«¯æµ‹è¯•</h1>
                
                <div class="stats">
                    <div class="stat-box">
                        <div class="stat-value" id="total-tests">0</div>
                        <div class="stat-label">æ€»æµ‹è¯•</div>
                    </div>
                    <div class="stat-box" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                        <div class="stat-value" id="passed-tests">0</div>
                        <div class="stat-label">é€šè¿‡</div>
                    </div>
                    <div class="stat-box" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);">
                        <div class="stat-value" id="failed-tests">0</div>
                        <div class="stat-label">å¤±è´¥</div>
                    </div>
                    <div class="stat-box" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                        <div class="stat-value" id="elapsed-time">0s</div>
                        <div class="stat-label">è€—æ—¶</div>
                    </div>
                </div>
                
                <div class="buttons">
                    <button class="btn-primary" onclick="runTests()">â–¶ï¸ å¼€å§‹æµ‹è¯•</button>
                    <button class="btn-danger" onclick="clearLog()">ğŸ—‘ï¸ æ¸…é™¤æ—¥å¿—</button>
                </div>
                
                <h2>ğŸ“‹ æµ‹è¯•æ­¥éª¤</h2>
                <div id="test-steps"></div>
            </div>
        </div>
        
        <!-- å³ä¾§æ—¥å¿—å’Œé¢„è§ˆ -->
        <div>
            <div class="panel">
                <h2>ğŸ“Š å®æ—¶æ—¥å¿—</h2>
                <div class="log" id="log">
                    <div class="log-entry">ç­‰å¾…æµ‹è¯•å¼€å§‹...</div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let testResults = {
            total: 0,
            passed: 0,
            failed: 0,
            startTime: null
        };
        
        const steps = [
            { id: 1, name: 'æ£€æŸ¥ç™»å½•çŠ¶æ€', desc: 'éªŒè¯ç”¨æˆ·æ˜¯å¦å·²ç™»å½•' },
            { id: 2, name: 'è·å–é¡¹ç›®åˆ—è¡¨', desc: 'ä»åç«¯è·å–ç”¨æˆ·çš„æ‰€æœ‰é¡¹ç›®' },
            { id: 3, name: 'éªŒè¯ç¼©ç•¥å›¾', desc: 'æ£€æŸ¥æ‰€æœ‰é¡¹ç›®æ˜¯å¦éƒ½æœ‰ç¼©ç•¥å›¾' },
            { id: 4, name: 'æ‰“å¼€é¡¹ç›®7', desc: 'åœ¨ç¼–è¾‘å™¨ä¸­æ‰“å¼€é¡¹ç›®ID 7' },
            { id: 5, name: 'éªŒè¯é¡¹ç›®åŠ è½½', desc: 'æ£€æŸ¥é¡¹ç›®æ•°æ®æ˜¯å¦æ­£ç¡®åŠ è½½' },
            { id: 6, name: 'éªŒè¯ç™»å½•çŠ¶æ€æ˜¾ç¤º', desc: 'æ£€æŸ¥ç¼–è¾‘å™¨ä¸­æ˜¯å¦æ˜¾ç¤ºç”¨æˆ·å' }
        ];
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.innerHTML = `<span class="timestamp">[${timestamp}]</span>${message}`;
            logDiv.insertBefore(entry, logDiv.firstChild);
            
            if (logDiv.children.length > 200) {
                logDiv.removeChild(logDiv.lastChild);
            }
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '<div class="log-entry">æ—¥å¿—å·²æ¸…é™¤</div>';
        }
        
        function updateStats() {
            document.getElementById('total-tests').textContent = testResults.total;
            document.getElementById('passed-tests').textContent = testResults.passed;
            document.getElementById('failed-tests').textContent = testResults.failed;
            
            if (testResults.startTime) {
                const elapsed = Math.floor((Date.now() - testResults.startTime) / 1000);
                document.getElementById('elapsed-time').textContent = elapsed + 's';
            }
        }
        
        function updateStepStatus(stepId, status) {
            const stepEl = document.getElementById(`step-${stepId}`);
            if (stepEl) {
                stepEl.className = `test-step ${status}`;
            }
        }
        
        function renderSteps() {
            const container = document.getElementById('test-steps');
            container.innerHTML = steps.map(step => `
                <div class="test-step pending" id="step-${step.id}">
                    <div class="step-title">æ­¥éª¤ ${step.id}: ${step.name}</div>
                    <div class="step-detail">${step.desc}</div>
                </div>
            `).join('');
        }
        
        async function runTest(stepId, testFunc) {
            testResults.total++;
            updateStepStatus(stepId, 'running');
            updateStats();
            
            try {
                const result = await testFunc();
                if (result) {
                    testResults.passed++;
                    updateStepStatus(stepId, 'success');
                    log(`âœ… æ­¥éª¤ ${stepId} é€šè¿‡`, 'success');
                } else {
                    testResults.failed++;
                    updateStepStatus(stepId, 'error');
                    log(`âŒ æ­¥éª¤ ${stepId} å¤±è´¥`, 'error');
                }
            } catch (error) {
                testResults.failed++;
                updateStepStatus(stepId, 'error');
                log(`âŒ æ­¥éª¤ ${stepId} å¼‚å¸¸: ${error.message}`, 'error');
            }
            
            updateStats();
        }
        
        async function runTests() {
            log('ğŸš€ å¼€å§‹ç«¯åˆ°ç«¯æµ‹è¯•...', 'info');
            testResults = { total: 0, passed: 0, failed: 0, startTime: Date.now() };
            updateStats();
            
            // æ­¥éª¤ 1: æ£€æŸ¥ç™»å½•çŠ¶æ€
            await runTest(1, async () => {
                log('ğŸ” æ£€æŸ¥ç™»å½•çŠ¶æ€...', 'info');
                const response = await fetch('http://localhost:8086/api/profile/', {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    log('âŒ æ— æ³•è®¿é—® /api/profile/', 'error');
                    return false;
                }
                
                const data = await response.json();
                
                if (data.error === null && data.data) {
                    const username = data.data.real_name || data.data.user?.username || 'æœªçŸ¥';
                    log(`âœ… ç”¨æˆ·å·²ç™»å½•: ${username}`, 'success');
                    return true;
                } else {
                    log('âš ï¸ ç”¨æˆ·æœªç™»å½•', 'warning');
                    return false;
                }
            });
            
            // æ­¥éª¤ 2: è·å–é¡¹ç›®åˆ—è¡¨
            let projects = [];
            await runTest(2, async () => {
                log('ğŸ“‹ è·å–é¡¹ç›®åˆ—è¡¨...', 'info');
                const response = await fetch('http://localhost:8086/api/scratch/mystuff/', {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    log('âŒ æ— æ³•è·å–é¡¹ç›®åˆ—è¡¨', 'error');
                    return false;
                }
                
                projects = await response.json();
                log(`âœ… è·å–æˆåŠŸï¼Œå…± ${projects.length} ä¸ªé¡¹ç›®`, 'success');
                
                projects.forEach(p => {
                    log(`  - é¡¹ç›® #${p.id}: ${p.title}`, 'info');
                });
                
                return projects.length > 0;
            });
            
            // æ­¥éª¤ 3: éªŒè¯ç¼©ç•¥å›¾
            await runTest(3, async () => {
                log('ğŸ–¼ï¸ éªŒè¯ç¼©ç•¥å›¾...', 'info');
                
                const projectsWithoutThumbnail = projects.filter(p => !p.cover_url);
                const projectsWithThumbnail = projects.filter(p => p.cover_url);
                
                log(`  âœ… æœ‰ç¼©ç•¥å›¾: ${projectsWithThumbnail.length} ä¸ª`, 'success');
                
                if (projectsWithoutThumbnail.length > 0) {
                    log(`  âš ï¸ æ— ç¼©ç•¥å›¾: ${projectsWithoutThumbnail.length} ä¸ª`, 'warning');
                    projectsWithoutThumbnail.forEach(p => {
                        log(`    - é¡¹ç›® #${p.id}: ${p.title}`, 'warning');
                    });
                }
                
                return projectsWithoutThumbnail.length === 0;
            });
            
            // æ­¥éª¤ 4: æ‰“å¼€é¡¹ç›® 7
            let project7 = null;
            await runTest(4, async () => {
                log('ğŸ“‚ è·å–é¡¹ç›® #7 è¯¦æƒ…...', 'info');
                
                const response = await fetch('http://localhost:8086/api/scratch/projects/7/', {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    log('âŒ æ— æ³•è·å–é¡¹ç›® #7', 'error');
                    return false;
                }
                
                project7 = await response.json();
                
                // éªŒè¯æ•°æ®ç»“æ„
                if (typeof project7.data_json === 'object' && project7.data_json.targets) {
                    log(`âœ… é¡¹ç›® #7 æ•°æ®æ ¼å¼æ­£ç¡®`, 'success');
                    log(`  - data_json ç±»å‹: å¯¹è±¡ âœ“`, 'success');
                    log(`  - targets å­˜åœ¨: ${project7.data_json.targets.length} ä¸ª`, 'success');
                    log(`  - cover_url: ${project7.cover_url ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}`, project7.cover_url ? 'success' : 'warning');
                    return true;
                } else {
                    log(`âŒ é¡¹ç›® #7 æ•°æ®æ ¼å¼é”™è¯¯`, 'error');
                    log(`  - data_json ç±»å‹: ${typeof project7.data_json}`, 'error');
                    return false;
                }
            });
            
            // æ­¥éª¤ 5: éªŒè¯é¡¹ç›®åŠ è½½èƒ½åŠ›
            await runTest(5, async () => {
                log('ğŸ” éªŒè¯é¡¹ç›®å¯åŠ è½½æ€§...', 'info');
                
                if (!project7) {
                    log('âš ï¸ é¡¹ç›® #7 æœªè·å–ï¼Œè·³è¿‡éªŒè¯', 'warning');
                    return false;
                }
                
                // æ£€æŸ¥å¿…è¦å­—æ®µ
                const requiredFields = ['id', 'title', 'data_json'];
                const missingFields = requiredFields.filter(field => !project7[field]);
                
                if (missingFields.length > 0) {
                    log(`âŒ ç¼ºå°‘å¿…è¦å­—æ®µ: ${missingFields.join(', ')}`, 'error');
                    return false;
                }
                
                // æ£€æŸ¥ data_json ç»“æ„
                if (!project7.data_json.targets || !Array.isArray(project7.data_json.targets)) {
                    log('âŒ data_json.targets ä¸æ˜¯æ•°ç»„', 'error');
                    return false;
                }
                
                log('âœ… é¡¹ç›®æ•°æ®ç»“æ„å®Œæ•´ï¼Œå¯ä»¥åŠ è½½åˆ°ç¼–è¾‘å™¨', 'success');
                return true;
            });
            
            // æ­¥éª¤ 6: æ£€æŸ¥ç¼–è¾‘å™¨é¡µé¢
            await runTest(6, async () => {
                log('ğŸŒ æ£€æŸ¥ç¼–è¾‘å™¨é¡µé¢...', 'info');
                
                const editorUrl = 'http://localhost:8081/classroom/scratch/editor/7';
                
                try {
                    const response = await fetch(editorUrl);
                    
                    if (response.ok) {
                        log('âœ… ç¼–è¾‘å™¨é¡µé¢å¯è®¿é—®', 'success');
                        log(`  - URL: ${editorUrl}`, 'info');
                        log('  â„¹ï¸ è¯·åœ¨æµè§ˆå™¨ä¸­æ‰‹åŠ¨æ‰“å¼€æ­¤é¡µé¢éªŒè¯ç™»å½•çŠ¶æ€', 'info');
                        return true;
                    } else {
                        log('âŒ ç¼–è¾‘å™¨é¡µé¢æ— æ³•è®¿é—®', 'error');
                        return false;
                    }
                } catch (error) {
                    log(`âŒ è®¿é—®ç¼–è¾‘å™¨é¡µé¢å¤±è´¥: ${error.message}`, 'error');
                    return false;
                }
            });
            
            // æµ‹è¯•å®Œæˆ
            const passRate = ((testResults.passed / testResults.total) * 100).toFixed(1);
            const elapsed = Math.floor((Date.now() - testResults.startTime) / 1000);
            
            log('', 'info');
            log('='.repeat(50), 'info');
            log(`ğŸ“Š æµ‹è¯•å®Œæˆï¼`, 'info');
            log(`  - æ€»æµ‹è¯•æ•°: ${testResults.total}`, 'info');
            log(`  - é€šè¿‡: ${testResults.passed}`, 'success');
            log(`  - å¤±è´¥: ${testResults.failed}`, testResults.failed > 0 ? 'error' : 'info');
            log(`  - é€šè¿‡ç‡: ${passRate}%`, passRate >= 80 ? 'success' : 'warning');
            log(`  - æ€»è€—æ—¶: ${elapsed}ç§’`, 'info');
            log('='.repeat(50), 'info');
            
            if (testResults.failed === 0) {
                log('ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼ç³»ç»Ÿè¿è¡Œæ­£å¸¸ï¼', 'success');
            } else {
                log('âš ï¸ éƒ¨åˆ†æµ‹è¯•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ä¸Šé¢çš„é”™è¯¯ä¿¡æ¯', 'warning');
            }
        }
        
        // åˆå§‹åŒ–
        window.addEventListener('load', () => {
            renderSteps();
            log('ğŸš€ æµ‹è¯•å·¥å…·å·²å‡†å¤‡å°±ç»ª', 'info');
            log('ç‚¹å‡»"å¼€å§‹æµ‹è¯•"æŒ‰é’®å¼€å§‹è‡ªåŠ¨åŒ–æµ‹è¯•', 'info');
        });
    </script>
</body>
</html>

